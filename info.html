<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>College Info</title>
  <meta name="robots" content="noindex">
  <style>
    /* Fallback theme tokens; will use your site's CSS variables if present */
    :root {
      --panel: #0f1316;
      --text: #e9f1f3;
      --accent: #00818a;     /* teal accent */
      --er-accent: #fed351;  /* house yellow */
      --border: rgba(255,255,255,0.12);
    }
    html, body {
      height: 100%;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(0,161,170,0.15), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      background-color: var(--panel);
      color: var(--text);
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .page {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: clamp(12px, 2vw, 28px);
    }
    header.pagehead {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .title {
      margin: 0;
      color: var(--accent);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .segmented {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      padding: 4px;
      border-radius: 12px;
      display: inline-flex;
      gap: 4px;
    }
    .segmented .seg {
      background: transparent;
      color: var(--text);
      border: 0;
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
      opacity: .85;
    }
    .segmented .seg.active {
      background: linear-gradient(180deg, rgba(0,160,170,0.25), rgba(0,160,170,0.18));
      border: 1px solid rgba(0,160,170,0.45);
      opacity: 1;
    }
    #collegeSelect {
      appearance: none;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 8px 12px;
      min-width: min(48vw, 460px);
      outline: none;
    }
    .backlink {
      color: var(--text);
      text-decoration: none;
      opacity: .8;
    }
    .backlink:hover { opacity: 1; text-decoration: underline; }

    main#collegeWrap {
      flex: 1;
      overflow: auto;
      padding-top: 10px;
    }
    article#collegeDetail {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .placeholder { color: rgba(233,241,243,0.7); font-style: italic; }

    .detail-head { display: flex; flex-wrap: wrap; gap: 12px; align-items: baseline; }
    .detail-title { font-size: clamp(22px, 3vw, 34px); margin: 0; color: var(--text); }
    .date-pill {
      display: inline-flex; gap: 8px; align-items: center; padding: 6px 10px;
      border-radius: 999px; font-weight: 800; letter-spacing: .3px;
      border: 1px solid rgba(0,160,170,0.45);
      background: linear-gradient(180deg, rgba(0,160,170,0.25), rgba(0,160,170,0.18));
    }
    .badge {
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; font-weight:800; letter-spacing:.3px; border:1px solid transparent;
    }
    .badge.internal { background: rgba(89,210,255,0.18); border-color: rgba(89,210,255,0.35); color:#bfefff; }
    .badge.external { background: rgba(255,209,102,0.20); border-color: rgba(255,209,102,0.45); color:#ffe6a6; }
    .detail-body p { margin: 0 0 10px 0; white-space: pre-wrap; }

    /* Print tweaks */
    @media print {
      .toolbar, .backlink { display: none !important; }
      html, body { background: #fff; color: #000; }
      .date-pill, .badge { border-color: #333 !important; background: #eee !important; color: #000 !important; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="pagehead">
      <h1 class="title">College Info</h1>
      <div class="toolbar">
        <div class="segmented" role="tablist" aria-label="Filter section">
          <button type="button" class="seg active" data-filter="ALL" aria-selected="true">All</button>
          <button type="button" class="seg" data-filter="INTERNAL" aria-selected="false">Internal</button>
          <button type="button" class="seg" data-filter="EXTERNAL" aria-selected="false">External</button>
        </div>
        <select id="collegeSelect" aria-label="Choose item"></select>
        <a class="backlink" href="/" onclick="if(history.length>1){history.back(); return false;}">Back</a>
      </div>
    </header>

    <main id="collegeWrap">
      <article id="collegeDetail" aria-live="polite">
        <div class="placeholder">Choose an item from the dropdown to view full details.</div>
      </article>
    </main>
  </div>

  <script>
  (function(){
    const MASTER_URL = 'reads.txt'; // put this file alongside info.html, or change the path
    const selectEl = document.getElementById('collegeSelect');
    const detailEl = document.getElementById('collegeDetail');
    const segs = document.querySelectorAll('.segmented .seg');

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

    // Format:
    // [Internal] / [External] (optional, persists)
    // From - dd/mm/yy To - dd/mm/yy
    // Heading
    // Body ...
    // (blank line)
    function parseMaster(text){
      const lines = text.split(/\r?\n/);
      let section = 'INTERNAL';
      const items = [];
      let i = 0;
      const reSection = /^\s*\[(internal|external)\]\s*$/i;
      const reFromTo = /^\s*From\s*-\s*(\d{1,2}\/\d{1,2}\/\d{2,4})\s*To\s*-\s*(\d{1,2}\/\d{1,2}\/\d{2,4})\s*$/i;

      function eatBlank(){ while(i < lines.length && /^\s*$/.test(lines[i])) i++; }

      while(i < lines.length){
        while(i < lines.length && reSection.test(lines[i])){ section = lines[i].match(reSection)[1].toUpperCase(); i++; }
        eatBlank(); if (i >= lines.length) break;

        const mFT = lines[i].match(reFromTo);
        if (!mFT){ i++; continue; }
        const from = mFT[1]; const to = mFT[2]; i++;

        eatBlank();
        const title = (lines[i] || '').trim(); i++;

        const bodyLines = [];
        while(i < lines.length && !/^\s*$/.test(lines[i]) && !reFromTo.test(lines[i]) && !reSection.test(lines[i])){
          bodyLines.push(lines[i]); i++;
        }
        items.push({ section, from, to, title, body: bodyLines.join('\n').trim() });

        while(i < lines.length && /^\s*$/.test(lines[i])) i++;
      }
      return items;
    }

    function fmtRange(it){ return `${it.from} – ${it.to}`; }

    let ALL_ITEMS = [];

    function populateSelect(mode){
      const filtered = ALL_ITEMS.filter(it => mode === 'ALL' || it.section === mode);
      const groups = { INTERNAL: [], EXTERNAL: [] };
      filtered.forEach(it => groups[it.section||'INTERNAL'].push(it));

      function optionHTML(it, idx){
        const label = `${fmtRange(it)} · ${it.title}`;
        return `<option value="${idx}">${escapeHtml(label)}</option>`;
      }

      let html = '<option value="" selected disabled>Choose an item…</option>';
      if (mode === 'ALL'){
        if (groups.INTERNAL.length){ html += `<optgroup label="Internal">` + groups.INTERNAL.map(it=>optionHTML(it, it._i)).join('') + `</optgroup>`; }
        if (groups.EXTERNAL.length){ html += `<optgroup label="External">` + groups.EXTERNAL.map(it=>optionHTML(it, it._i)).join('') + `</optgroup>`; }
      } else {
        html += filtered.map(it => optionHTML(it, it._i)).join('');
      }
      selectEl.innerHTML = html;
    }

    function renderDetail(it){
      if (!it){
        detailEl.innerHTML = '<div class="placeholder">Choose an item from the dropdown to view full details.</div>';
        return;
      }
      const sectBadge = `<span class="badge ${it.section==='INTERNAL'?'internal':'external'}">${it.section.toLowerCase()}</span>`;
      detailEl.innerHTML = \`
        <div class="detail-head">
          <h2 class="detail-title">\${escapeHtml(it.title)}</h2>
          <span class="date-pill">\${escapeHtml(fmtRange(it))}</span>
          \${sectBadge}
        </div>
        <div class="detail-body">
          \${it.body ? it.body.split(/\n/).map(p => \`<p>\${escapeHtml(p)}</p>\`).join('') : '<p class="placeholder">No extra details.</p>'}
        </div>\`;
      detailEl.scrollTop = 0;
    }

    function applyMode(mode){
      populateSelect(mode);
      renderDetail(null);
    }

    function initControls(){
      segs.forEach(btn => btn.addEventListener('click', ()=>{
        segs.forEach(b => { b.classList.toggle('active', b===btn); b.setAttribute('aria-selected', b===btn ? 'true':'false'); });
        const mode = (btn.dataset.filter || 'ALL').toUpperCase();
        const u = new URL(location.href);
        u.searchParams.set('mode', mode);
        history.replaceState(null, '', u);
        applyMode(mode);
      }));
      selectEl.addEventListener('change', () => {
        const idx = selectEl.value ? parseInt(selectEl.value,10) : NaN;
        const item = Number.isInteger(idx) ? ALL_ITEMS.find(x => x._i === idx) : null;
        renderDetail(item || null);
      });
    }

    function refreshCollege(){
      const url = MASTER_URL + (MASTER_URL.includes('?') ? '&' : '?') + 'v=' + Date.now();
      return fetch(url)
        .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(txt => {
          const items = parseMaster(txt);
          items.forEach((it, i)=> it._i = i);
          ALL_ITEMS = items;

          // Initialise mode & selection from query params
          try{
            const u = new URL(location.href);
            const mode = (u.searchParams.get('mode') || 'ALL').toUpperCase();
            const pick = u.searchParams.get('pick'); // index
            const auto = (u.searchParams.get('autoselect') || '').toLowerCase();

            // apply mode
            const segMap = {ALL:0, INTERNAL:1, EXTERNAL:2};
            const segsArr = Array.from(segs);
            const segToActivate = segMap[mode] ?? 0;
            segsArr.forEach((b, idx) => {
              const on = idx === segToActivate;
              b.classList.toggle('active', on);
              b.setAttribute('aria-selected', on?'true':'false');
            });
            applyMode(mode);

            // optional default selection
            if (pick !== null && pick !== '' && ALL_ITEMS[+pick]){
              selectEl.value = String(+pick);
              selectEl.dispatchEvent(new Event('change'));
            } else if (auto === 'current'){
              // choose first item whose "to" date is today-or-future (DD/MM/YY)
              const now = new Date();
              function parseDMY(s){
                const [d,m,y] = s.split('/').map(n=>parseInt(n,10));
                const year = y < 100 ? 2000 + y : y;
                return new Date(year, m-1, d, 23, 59, 59);
              }
              const idx = ALL_ITEMS.findIndex(it => {
                try { return parseDMY(it.to) >= now; } catch(e){ return false; }
              });
              if (idx > -1){
                selectEl.value = String(idx);
                selectEl.dispatchEvent(new Event('change'));
              }
            }
          }catch(e){ /* noop */ }
        })
        .catch(err => {
          detailEl.innerHTML = '<p style="color:#ff7d7d">Could not load reads.txt (' + err.message + ')</p>';
        });
    }

    document.addEventListener('DOMContentLoaded', () => { refreshCollege().then(initControls); });
  })();
  </script>
</body>
</html>
