<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio – Clean Now Playing</title>
  <style>
    :root {
      --bg: #0d0f14;
      --panel: #161a22;
      --text: #e9edf3;
      --muted: #a7b1c2;
      --brand: #fed351;
      --teal: #00818a;
      --danger: #e53935;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #152033 0%, #0d0f14 60%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: grid;
      place-items: center;
    }
    .wrap {
      width: min(880px, 92vw);
      background: var(--panel);
      border: 1px solid #1e2531;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 18px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; margin-bottom: 8px;
    }
    h1 { font-size: 1.1rem; margin: 0; letter-spacing: .2px; color: var(--brand); }
    .badge { font-size: .85rem; padding: 4px 10px; border-radius: 999px; background: #202836; color: var(--muted); }
    .player {
      display: grid; gap: 12px;
      grid-template-columns: 1fr;
      padding: 10px; border-radius: 12px; background: #131823; border: 1px solid #1d2431;
    }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button, .btn {
      background: var(--brand); color: #111;
      border: none; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
    }
    button:active { transform: translateY(1px); }
    #now-playing {
      line-height: 1.4;
      font-size: .98rem;
      background: #0f1420;
      border: 1px solid #1a2130;
      border-radius: 12px;
      padding: 12px 14px;
    }
    .live-indicator { margin-left: 8px; color: var(--danger); font-weight: 700; font-size: .95rem; }
    .live-indicator .dot { display: inline-block; width: .6em; height: .6em; border-radius: 50%; background: var(--danger); margin-right: 6px; box-shadow: 0 0 10px rgba(229,57,53,.7); }
    #np-progress { display:none; height: 8px; border-radius: 999px; background: #0d1320; border: 1px solid #1a2130; overflow: hidden; margin-top: 10px; }
    #np-progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--teal), #16b2bd); transition: width .15s linear; }
    #np-progress.ending-soon .bar { background: linear-gradient(90deg, #ff7a13, #e53935); }
    footer { margin-top: 10px; color: var(--muted); font-size: .85rem; }
    .small { color: var(--muted); font-size: .9rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Essential Radio – Now Playing</h1>
      <span class="badge">Clean build</span>
    </header>

    <div class="player">
      <div class="controls">
        <button id="play">▶️ Play</button>
        <div class="small">If your stream auto-plays elsewhere, this stays off to keep browsers happy.</div>
      </div>

      <div id="now-playing">
        <span style="color:var(--brand);">Now Playing:</span>
        <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>
        <span style="font-weight:700;">More music soon</span><br/>
        <span class="small">on Essential Radio</span>
      </div>

      <div id="np-progress"><div class="bar"></div></div>
      <audio id="audio" preload="none"></audio>
    </div>

    <footer>
      Polling <code>/api/latestTrack</code> → fallback <code>/api/latestAlt</code>. Shows title/artist even when ALT lacks timing.
    </footer>
  </div>

  <script>
    // --- Minimal audio for testing (leave src blank for your prod stream) ---
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play');
    playBtn.addEventListener('click', async () => {
      try {
        // Set your stream URL here if you want local testing
        if (!audio.src) audio.src = '';
        if (audio.paused) { await audio.play(); playBtn.textContent = '⏸ Pause'; }
        else { audio.pause(); playBtn.textContent = '▶️ Play'; }
      } catch {}
    });

    // --- Progress bar helpers (safe no-ops if unused) ---
    let _npRaf = 0;
    function hardResetBar() {
      try { cancelAnimationFrame(_npRaf); } catch {}
      const prog = document.getElementById('np-progress');
      if (prog) { prog.classList.remove('ending-soon'); prog.style.display = 'none'; }
      const bar = prog?.querySelector('.bar');
      if (bar) bar.style.width = '0%';
    }
    function startBarAnimation(startMs, endMs) {
      const prog = document.getElementById('np-progress');
      const bar = prog?.querySelector('.bar');
      if (!prog || !bar) return;

      function tick() {
        const now = Date.now();
        const span = endMs - startMs;
        const done = Math.min(Math.max((now - startMs) / span, 0), 1);
        bar.style.width = (done * 100).toFixed(3) + '%';
        if (endMs - now <= 10_000) prog.classList.add('ending-soon'); else prog.classList.remove('ending-soon');
        if (now < endMs) { _npRaf = requestAnimationFrame(tick); }
      }
      try { cancelAnimationFrame(_npRaf); } catch {}
      _npRaf = requestAnimationFrame(tick);
    }
    function showMoreMusicSoon() {
      const el = document.getElementById('now-playing');
      const prog = document.getElementById('np-progress');
      if (el) {
        el.innerHTML = '<span style="color:#fed351;">Now Playing:</span> <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>' +
                       '<span style="font-weight:700;">More music soon</span><br/>' +
                       '<span class="small">on Essential Radio</span>';
      }
      hardResetBar();
      try { document.title = 'Essential Radio – Essential listening'; } catch {}
    }
  </script>

  <!-- --- Safe ALT-aware Now Playing override (standalone & clean) --- -->
  <script>
  (function () {
    const POLL_MS = 7000;     // gentle polling
    const TIMEOUT_MS = 4500;  // fetch timeout
    let timer = null;

    if (window.__npAltOverrideAttached) return;
    window.__npAltOverrideAttached = true;

    async function fetchJson(url) {
      const ctl = new AbortController();
      const id = setTimeout(() => ctl.abort(), TIMEOUT_MS);
      try {
        const r = await fetch(url + '?_=' + Date.now(), { cache: 'no-store', signal: ctl.signal });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return await r.json();
      } finally { clearTimeout(id); }
    }

    async function getLatestFrom(endpoints) {
      for (const u of endpoints) {
        try {
          const raw = await fetchJson(u);
          if (!raw) continue;

          let artist = raw.artist ?? raw.artistName ?? raw.artists ?? '';
          let title  = raw.title  ?? raw.trackTitle ?? raw.name    ?? '';

          if (!artist && title && title.includes(' - ')) {
            const [a, t] = title.split(' - ');
            if (a && t) { artist = a.trim(); title = t.trim(); }
          }

          let duration = raw.duration ?? raw.length ?? null;
          if (typeof duration === 'string') duration = parseInt(duration, 10);
          if (Number.isNaN(duration)) duration = null;

          let startTime = raw.startTime ?? raw.startedAt ?? raw.start ?? null;
          if (typeof startTime === 'string' &&
              /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(startTime)) {
            startTime += 'Z';
          }

          if ((artist && title) || (duration && startTime)) {
            return { artist, title, duration, startTime };
          }
        } catch { /* try next */ }
      }
      return null;
    }

    async function updateNowPlayingOnce() {
      const npEl = document.getElementById('now-playing');
      const prog = document.getElementById('np-progress');

      const latest = await getLatestFrom(['/api/latestTrack', '/api/latestAlt']);
      if (!latest) { showMoreMusicSoon(); return; }

      const { artist, title, duration, startTime } = latest;

      if (npEl) {
        npEl.innerHTML = `
          <span style="color:#fed351;">Now Playing:</span>
          <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>
          <span style="color:white;font-weight:600;font-size:1.2em;">${title || 'Live'}</span><br/>
          <span class="small">${artist ? 'by ' + artist : 'on Essential Radio'}</span>`;
      }
      try { document.title = (artist && title) ? \`Essential Radio: \${artist} - \${title}\` : 'Essential Radio'; } catch {}

      if (!duration || !startTime) {
        if (prog) { prog.style.display = 'none'; const bar = prog.querySelector('.bar'); if (bar) bar.style.width = '0%'; }
        return;
      }

      const startMs = new Date(startTime).getTime();
      const endMs = startMs + duration * 1000;
      if (Date.now() > endMs) { showMoreMusicSoon(); return; }

      if (prog) prog.style.display = 'block';

      const key = \`\${artist || ''}||\${title || ''}||\${startMs}\`;
      if (window._npActiveKey !== key) {
        window._npActiveKey = key;
        try { hardResetBar(); } catch(e){}
        window._npLastTiming = { startMs, endMs };
        try { startBarAnimation(startMs, endMs); } catch(e){}
      } else {
        window._npLastTiming = { startMs, endMs };
      }
    }

    function startPolling() {
      if (timer) clearInterval(timer);
      updateNowPlayingOnce().catch(()=>{});
      timer = setInterval(() => updateNowPlayingOnce().catch(()=>{}), POLL_MS);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startPolling, { once: true });
    } else {
      startPolling();
    }
  })();
  </script>
</body>
</html>
