<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recent Combined Test</title>
</head>
<body>
  <!-- Existing content would be here -->
  <div id="recent-list"></div>

  <script>
  (function() {
    const RECENT_LIMIT = 5;
    const RECENT_KEY = "recentCacheV1";

    async function fetchRollingLog() {
      try {
        const res = await fetch("playout_log_rolling.json");
        if (!res.ok) return [];
        return await res.json();
      } catch(e) { return []; }
    }

    async function fetchApiRecent() {
      try {
        const res = await fetch("/api/recent");
        if (!res.ok) return [];
        return await res.json();
      } catch(e) { return []; }
    }

    function mergeRecent(a, b) {
      const map = new Map();
      [...a, ...b].forEach(item => {
        const key = (item.artist + "|" + item.title).toLowerCase();
        if (!map.has(key)) map.set(key, item);
      });
      return Array.from(map.values())
        .sort((x,y) => new Date(y.startTime||0) - new Date(x.startTime||0))
        .slice(0, RECENT_LIMIT);
    }

    async function seedRecent() {
      let cache = JSON.parse(localStorage.getItem(RECENT_KEY)||"[]");
      if (cache.length) {
        cache.slice().reverse().forEach(track => {
          if (window.prependRecentFromTrack) window.prependRecentFromTrack(track);
        });
      }

      const [log, api] = await Promise.all([fetchRollingLog(), fetchApiRecent()]);
      const merged = mergeRecent(log, api);

      if (merged.length) {
        const list = document.getElementById("recent-list");
        if (list) list.innerHTML = "";
        merged.slice().reverse().forEach(track => {
          if (window.prependRecentFromTrack) window.prependRecentFromTrack(track);
        });
        localStorage.setItem(RECENT_KEY, JSON.stringify(merged));
      }
    }

    document.addEventListener("DOMContentLoaded", seedRecent);

    // Artwork patcher
    const observer = new MutationObserver(muts => {
      muts.forEach(m => {
        m.addedNodes.forEach(node => {
          if (node.nodeType===1 && node.querySelector) {
            const img = node.querySelector("img");
            const artist = node.querySelector(".artist")?.textContent || "";
            const title = node.querySelector(".title")?.textContent || "";
            if (img && img.src.includes("ERLogo2.png") && artist && title) {
              fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist + " " + title)}&entity=song&limit=1&country=gb`)
                .then(r=>r.json()).then(d=>{
                  if (d.results && d.results[0]) {
                    img.src = d.results[0].artworkUrl100.replace("100x100bb","300x300bb");
                  } else {
                    img.src = "ERLogo2.png";
                  }
                }).catch(()=>{ img.src="ERLogo2.png"; });
            }
          }
        });
      });
    });
    observer.observe(document.getElementById("recent-list"), {childList:true});
  })();
  </script>
</body>
</html>
