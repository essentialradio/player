<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio Player</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ----------  GLOBAL LAYOUT & THEME ---------- */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 50px 30px 30px;
      background: linear-gradient(135deg, #00818a, #7e1974);
      color: white;
      display: flex;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .strip-container { display:flex; flex-direction:row; width:100%; max-width:1100px; min-height:280px; border-radius:15px; overflow:hidden; box-shadow:0 0 25px rgba(0,0,0,0.5); background:#111; position:relative; z-index:1; }
    .left-panel, .right-panel { width:50%; padding:20px 30px; box-sizing:border-box; display:flex; flex-direction:column; }
    .left-panel { background:#111; align-items:center; text-align:center; border-right:1px solid #333; justify-content:flex-start; padding-top:30px; }
    .right-panel { background:#222; overflow-y:auto; border-left:1px solid #333; }
    #player-box { max-width:420px; width:100%; }
    button { background:#fed351; color:#111; border-radius:8px; padding:12px 24px; font-weight:600; font-size:18px; border:none; cursor:pointer; transition:background 0.3s ease, box-shadow 0.3s ease; user-select:none; }
    button:hover, button:focus { background:#e5c73f; box-shadow:0 0 10px #fed351cc; outline:none; }
    #mute-toggle { font-size:16px; padding:6px 12px; margin-left:10px; }
    #volume-container { margin-top:15px; display:flex; align-items:center; justify-content:center; gap:10px; }
    #volume-container label { font-size:16px; margin:0; user-select:none; }
    #volume-slider { width:180px; cursor:pointer; }
    #volume-display { font-size:16px; color:#ccc; min-width:40px; text-align:left; user-select:none; }
    #onAirNow { margin:10px 0; text-align:right; padding-right:16px; max-width:95%; margin-left:auto; }
    #onAirNow span { display:block; line-height:1.2; }
    .show-title { font-weight:600; }
    .show-presenter { font-weight:400; font-size:0.95em; opacity:0.9; }
    #now-playing-card { margin-top:25px; background:#1a1a1a; border-radius:10px; padding:20px; box-shadow:0 0 15px rgba(0,131,138,0.7); max-width:420px; text-align:left; font-size:17px; line-height:1.7; color:white; }
    #artwork { margin-top:25px; border-radius:8px; width:280px; height:280px; object-fit:cover; border:2px solid #fed351; box-shadow:0 0 15px #fed351aa; opacity:0; filter:blur(10px) brightness(0.8); transition:opacity 0.4s ease-in-out,filter 0.4s ease-in-out; }
    #artwork.loaded { opacity:1; filter:blur(0) brightness(1); }
    #artwork.fallback { opacity:0.7; filter:blur(5px) brightness(0.8); box-shadow:0 0 10px rgba(254,211,81,0.4); }
    .recent-title { font-size:20px; font-weight:600; margin-bottom:20px; color:#fed351; user-select:none; }
    ul#recent-list { list-style:none; padding:0; margin:0; }
    ul#recent-list li { display:flex; align-items:center; gap:14px; padding:14px 0; border-bottom:1px solid #444; transition:background 0.2s ease; }
    ul#recent-list li:hover { background:rgba(255,255,255,0.05); }
    ul#recent-list img { width:50px; height:50px; border-radius:6px; object-fit:cover; border:1px solid #fed351; box-shadow:0 0 5px rgba(0,0,0,0.4); opacity:0; transition:opacity 0.4s ease-in-out; }
    ul#recent-list img.loaded { opacity:1; }
    ul#recent-list span.time { color:#fed351; font-weight:600; width:50px; text-align:right; flex-shrink:0; user-select:none; }
    ul#recent-list span.info { flex:1; color:white; font-size:16px; user-select:none; }
    .logo-overhang { position:absolute; top:0; left:0; transform:translate(-30%,-30%); width:220px; z-index:2; opacity:0.97; pointer-events:none; user-select:none; filter:drop-shadow(0 4px 6px rgba(0,0,0,0.35)); }
    @media (max-width:768px) { .strip-container { flex-direction:column; } .left-panel, .right-panel { width:100%; padding:20px; } #volume-container { display:none!important; } .logo-overhang { width:120px; transform:translate(-25%,-25%); top:2px; left:20px; } }
  </style>
</head>
<body>
  <div class="player-wrapper">
    <img src="ERLogo2.png" alt="Essential Radio Logo" class="logo-overhang" />
    <div class="strip-container">
      <div class="left-panel">
        <div id="onAirNow"><span style="color:#fed351;font-weight:700;">ON AIR NOW:</span><br><span id="currentShow" style="font-weight:600;">Loading‚Ä¶</span></div>
        <div id="player-box">
          <audio id="stream" preload="none"><source src="https://streaming06.liveboxstream.uk/proxy/ayrshire/stream" type="audio/mpeg" /></audio>
          <button id="play-toggle">‚ñ∂Ô∏è Play Essential Radio</button>
          <div id="volume-container"><label for="volume-slider">Volume:</label><input type="range" id="volume-slider" min="0" max="100" value="100" /><span id="volume-display">100%</span><button id="mute-toggle">üîä</button></div>
          <div id="now-playing-card"><div id="now-playing">Loading current track‚Ä¶</div></div>
          <img id="artwork" src="Essential Radio Logo.png" alt="Artwork" />
        </div>
      </div>
      <div class="right-panel"><div class="recent-title">Recently Played</div><ul id="recent-list"></ul></div>
    </div>
  </div>
  <script>
    let artworkCache={};try{const s=localStorage.getItem('artworkCache');if(s)artworkCache=JSON.parse(s);}catch{}
    const artworkObserver=new IntersectionObserver(e=>{e.forEach(o=>{if(o.isIntersecting){o.target.classList.add('loaded');artworkObserver.unobserve(o.target);}});},{threshold:0.1});
    function formatShowTitleMobileOnly(t){if(window.innerWidth<=600){let m=t.match(/(.*)\s+with\s+(.*)/i);if(m)return`${m[1]}<br>with ${m[2]}`;}return t;}
    const showSpan=document.getElementById('currentShow'), showObserver=new MutationObserver(()=>{showSpan.innerHTML=formatShowTitleMobileOnly(showSpan.textContent);} ); if(showSpan){showObserver.observe(showSpan,{childList:true});showSpan.innerHTML=formatShowTitleMobileOnly(showSpan.textContent);} 
    async function fetchSchedule(){/* implement schedule fetch */}
    function getCurrentShow(s){let n=new Date(),d=n.toLocaleString('en-GB',{weekday:'long'}),sh=s?.[d]||[],m=n.getHours()*60+n.getMinutes();for(let x of sh){let [H,M]=x.start.split(':').map(Number),[h,mn]=x.end.split(':').map(Number),st=H*60+M,et=mn==0&&H>0?1440:h*60+mn;if(m>=st&&m<et)return x.title;}return'Off Air';}
    async function updateOnAirNow(){let sch=await fetchSchedule(),c=sch?getCurrentShow(sch):'Schedule unavailable',el=document.getElementById('currentShow');if(c.includes(' with ')){let [t,p]=c.split(' with ');el.innerHTML=`<span class="show-title">${t}</span><span class="show-presenter">with ${p}</span>`;}else el.textContent=c;} updateOnAirNow();setInterval(updateOnAirNow,60000);
    const aud=document.getElementById('stream'),playBtn=document.getElementById('play-toggle'),muteBtn=document.getElementById('mute-toggle'),vol=document.getElementById('volume-slider'),volDisp=document.getElementById('volume-display'),np=document.getElementById('now-playing'),art=document.getElementById('artwork');if(window.innerWidth<=768){vol.disabled=true;muteBtn.disabled=true;}let isP=false;playBtn.addEventListener('click',()=>{if(!isP){aud.load();aud.play().catch();playBtn.textContent='‚è∏ Pause';}else{aud.pause();playBtn.textContent='‚ñ∂Ô∏è Play Essential Radio';}isP=!isP;});vol.addEventListener('input',()=>{let v=vol.value/100;aud.volume=v;volDisp.textContent=`${vol.value}%`;muteBtn.textContent=v===0?'üîá':v<0.5?'üîà':'üîä';});muteBtn.addEventListener('click',()=>{aud.muted=!aud.muted;muteBtn.textContent=aud.muted?'üîá':aud.volume<0.5?'üîà':'üîä';volDisp.textContent=aud.muted?'Muted':`${vol.value}%`;});
    async function getTrackArtwork(q){if(artworkCache[q]!=null)return artworkCache[q];try{let r=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&limit=1`),j=await r.json();if(j.results[0]?.artworkUrl100){let u=j.results[0].artworkUrl100.replace('100x100','300x300');artworkCache[q]=u;localStorage.setItem('artworkCache',JSON.stringify(artworkCache));return u;}}catch{}let [a,t]='unknown'.split();let i=q.indexOf(' - ');if(i>-1)[a,t]=[q.slice(0,i),q.slice(i+3)];a=a.trim().replace(/\s+/g,'_');t=t.trim().replace(/\s+/g,'_');let u=`https://cdn.autopo.st/images/coverart/${a[0]?.toLowerCase()||'u'}/${a}_${t}.jpg`;try{let h=await fetch(u,{method:'HEAD'});if(h.ok){artworkCache[q]=u;localStorage.setItem('artworkCache',JSON.stringify(artworkCache));return u;}}catch{}artworkCache[q]='';localStorage.setItem('artworkCache',JSON.stringify(artworkCache));return'';}
    async function fetchNowPlaying(){try{let d=await (await fetch('/api/metadata')).json(),raw=d.nowPlaying||'',sep=raw.includes(' ‚Äì ')?' ‚Äì ':raw.includes(' - ')?' - ':null,[ar,ti]=sep?raw.split(sep):['',''];if(sep){np.innerHTML=`<span style="color:#fed351;">Now Playing:</span><span class="live-indicator"><span class="dot"></span>LIVE</span><br/><span style="font-weight:600;font-size:1.2em;">${ti}</span><br/><span>by ${ar}</span>`;fetchArtworkFull(`${ar} - ${ti}`);}else{np.innerHTML='<span>More music soon</span>';art.src='Essential Radio Logo.png';art.className='fallback';}}catch{np.textContent='Error loading track';}}
    async function fetchRecentTracks(){try{let data=await (await fetch('https://essentialradio.github.io/player/playout_log_rolling.json')).json(),last=data.filter(i=>i.Artist&&i.Title).slice(-5).reverse(),lis=await Promise.all(last.map(async i=>{let t=i['Scheduled Time']||i.time||'',name=`${i.Artist} ‚Äì ${i.Title}`,img=await getTrackArtwork(name)||'Essential Radio Logo.png';return`<li><span class="time">${t}</span><img src="${img}" alt="${name}" loading="lazy"/><span class="info">${name}</span></li>`;}));document.getElementById('recent-list').innerHTML=lis.join('');document.querySelectorAll('#recent-list img').forEach(i=>artworkObserver.observe(i));}catch{} }
    async function fetchArtworkFull(n){art.className='';try{let j=await(await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(n)}&limit=1`)).json();if(j.results[0]?.artworkUrl100){let u=j.results[0].artworkUrl100.replace('100x100','300x300');art.onload=()=>art.classList.add('loaded');art.onerror=()=>art.classList.add('fallback');art.src=u;return;}}catch{}art.src='Essential Radio Logo.png';art.classList.add('fallback');}
    fetchNowPlaying();setInterval(fetchNowPlaying,15000);fetchRecentTracks();setInterval(fetchRecentTracks,15000);
  </script>
</body>
</html>
