<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio Player</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ‚Äî‚Äî‚Äî STYLES (unchanged) ‚Äî‚Äî‚Äî */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 80px 30px 30px;
      background: linear-gradient(135deg,#00818a,#7e1974);
      color:#fff;
      display:flex;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .strip-container{display:flex;flex-direction:row;width:100%;max-width:1100px;min-height:280px;border-radius:15px;overflow:hidden;box-shadow:0 0 25px rgba(0,0,0,.5);background:#111}
    .left-panel,.right-panel{width:50%;padding:20px 30px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:center}
    .left-panel{background:#111;align-items:center;text-align:center;border-right:1px solid #333}
    .right-panel{background:#222;overflow-y:auto;border-left:1px solid #333}
    #player-box{max-width:420px;width:100%}
    button{background:#fed351;color:#111;border-radius:8px;padding:12px 24px;font-weight:600;font-size:18px;border:none;cursor:pointer;transition:background-color .3s,box-shadow .3s;user-select:none}
    button:hover,button:focus{background:#e5c73f;box-shadow:0 0 10px #fed351cc;outline:none}
    #mute-toggle{font-size:16px;padding:6px 12px;margin-left:10px}
    #volume-container{margin-top:15px;display:flex;align-items:center;justify-content:center;gap:10px}
    #volume-slider{width:180px;cursor:pointer}
    #volume-display{font-size:16px;color:#ccc;min-width:40px;text-align:left;user-select:none}
    #now-playing-card{margin-top:25px;background:#1a1a1a;border-radius:10px;padding:20px;box-shadow:0 0 15px rgba(0,131,138,.7);max-width:420px;text-align:left;font-size:17px;line-height:1.7;color:#fff}
    #artwork{margin-top:25px;border-radius:8px;width:280px;height:280px;object-fit:cover;border:2px solid #fed351;box-shadow:0 0 15px #fed351aa;user-select:none;opacity:0;filter:blur(10px) brightness(.8);transition:opacity .4s,filter .4s}
    #artwork.loaded{opacity:1;filter:blur(0) brightness(1)}
    #artwork.fallback{filter:blur(5px) brightness(.8);opacity:.7;box-shadow:0 0 10px rgba(254,211,81,.4)}
    .recent-title{font-size:20px;font-weight:600;margin-bottom:20px;color:#fed351;user-select:none}
    ul#recent-list{list-style:none;padding:0;margin:0}
    ul#recent-list li{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid #444;transition:background .2s}
    ul#recent-list li:hover{background:rgba(255,255,255,.05)}
    ul#recent-list img{width:50px;height:50px;border-radius:6px;object-fit:cover;border:1px solid #fed351;box-shadow:0 0 5px rgba(0,0,0,.4);opacity:0;transition:opacity .4s}
    ul#recent-list img.loaded{opacity:1}
    ul#recent-list span.time{color:#fed351;font-weight:600;width:50px;text-align:right;flex-shrink:0;user-select:none}
    ul#recent-list span.info{flex:1;color:#fff;font-size:16px;user-select:none}
    .live-indicator{display:inline-flex;align-items:center;gap:6px;font-weight:bold;color:#ff4d4d;font-size:.95em;margin-left:10px}
    .live-indicator .dot{width:10px;height:10px;border-radius:50%;background:#ff4d4d;animation:pulse 1.2s infinite}
    @keyframes pulse{0%,100%{opacity:.2;transform:scale(1)}50%{opacity:1;transform:scale(1.4)}}
    @media(max-width:768px){.strip-container{flex-direction:column}.left-panel,.right-panel{width:100%;padding:20px}#artwork{width:100%;max-width:280px;height:auto}}
  </style>
</head>

<body>
  <!-- ON-AIR BANNER -->
  <div id="onAirNow" style="position:absolute;top:20px;right:20px;background:rgba(0,0,0,.7);padding:12px 16px;border-radius:12px;font-family:'Inter',sans-serif;font-size:16px;color:#fff;box-shadow:0 0 10px rgba(0,0,0,.3);z-index:1000">
    <span style="color:#fed351;font-weight:700">ON&nbsp;AIR&nbsp;NOW:</span><br>
    <span id="currentShow" style="font-weight:600">Loading‚Ä¶</span>
  </div>

  <!-- PLAYER -->
  <div class="strip-container">
    <div class="left-panel">
      <div id="player-box">
        <audio id="stream" preload="none">
          <source src="https://streaming06.liveboxstream.uk/proxy/ayrshire/stream" type="audio/mpeg" />
        </audio>

        <button id="play-toggle">‚ñ∂Ô∏è Play Essential Radio</button>

        <div id="volume-container">
          <label for="volume-slider">Volume:</label>
          <input type="range" id="volume-slider" min="0" max="100" value="100" />
          <span id="volume-display">100%</span>
          <button id="mute-toggle">üîä</button>
        </div>

        <div id="now-playing-card">
          <div id="now-playing">Loading current track‚Ä¶</div>
        </div>

        <img id="artwork" src="Essential Radio Logo.png" alt="Station artwork" class="loaded" />
      </div>
    </div>

    <div class="right-panel">
      <div class="recent-title">Recently Played</div>
      <ul id="recent-list"></ul>
    </div>
  </div>

  <!-- ====== ALL SCRIPTS ====== -->
  <script>
    /* ---------- Schedule / ON-AIR NOW ---------- */
    async function fetchSchedule() {
      try {
        const res = await fetch("https://essentialradio.github.io/player/schedule.json");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error("Schedule fetch error:", e);
        return null;
      }
    }
    function getCurrentShow(schedule) {
      const now = new Date();
      const day = now.toLocaleString("en-GB",{weekday:"long"});
      const shows = schedule[day] || [];
      const nowM = now.getHours()*60 + now.getMinutes();
      for (const show of shows){
        const [sh,sm]=show.start.split(":").map(Number);
        const [eh,em]=show.end.split(":").map(Number);
        const start=sh*60+sm; let end=eh*60+em;
        if(end===0 && start>0) end=1440;
        if(nowM>=start && nowM<end) return show.title;
      }
      return "Off Air";
    }
    async function updateOnAirNow(){
      const schedule = await fetchSchedule();
      document.getElementById("currentShow").textContent =
        schedule ? getCurrentShow(schedule) : "Schedule unavailable";
    }
    updateOnAirNow();
    setInterval(updateOnAirNow, 60_000);

    /* ---------- Now-Playing & Recent ---------- */
    const audio        = document.getElementById("stream");
    const playBtn      = document.getElementById("play-toggle");
    const muteBtn      = document.getElementById("mute-toggle");
    const volSlider    = document.getElementById("volume-slider");
    const volDisplay   = document.getElementById("volume-display");
    const nowPlayingEl = document.getElementById("now-playing");
    const artworkImg   = document.getElementById("artwork");
    const recentList   = document.getElementById("recent-list");

    let isPlaying=false, lastVol=1;

    playBtn.addEventListener("click",()=>{
      if(!isPlaying){
        audio.pause(); audio.load();
        audio.play().catch(e=>console.error("Play failed:",e));
        playBtn.textContent="‚è∏ Pause";
        isPlaying=true;
      }else{
        audio.pause();
        playBtn.textContent="‚ñ∂Ô∏è Play Essential Radio";
        isPlaying=false;
      }
    });
    volSlider.addEventListener("input",()=>{
      const v=volSlider.value/100;
      audio.volume=v; volDisplay.textContent=`${volSlider.value}%`;
      muteBtn.textContent= v===0?"üîá": v<0.5?"üîà":"üîä";
    });
    muteBtn.addEventListener("click",()=>{
      if(audio.volume>0){
        lastVol=audio.volume; audio.volume=0;
        volSlider.value=0; volDisplay.textContent="0%"; muteBtn.textContent="üîá";
      }else{
        audio.volume=lastVol; volSlider.value=lastVol*100;
        volDisplay.textContent=`${Math.round(lastVol*100)}%`;
        muteBtn.textContent= lastVol<0.5?"üîà":"üîä";
      }
    });

    /* --- helpers --- */
    const decodeHtml = s => { const t=document.createElement("textarea"); t.innerHTML=s; return t.value; };

    async function getTrackArtwork(query){
      try{
        const r=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&limit=1`);
        const d=await r.json();
        if(d.results?.[0]?.artworkUrl100) return d.results[0].artworkUrl100.replace("100x100","300x300");
      }catch{}
      return "";
    }

    function setArtwork(url,isFallback=false){
      artworkImg.classList.remove("loaded","fallback");
      artworkImg.src=url;
      artworkImg.onload=()=>artworkImg.classList.add("loaded",isFallback?"fallback":"");
    }

    /* --- now playing --- */
    async function fetchNowPlaying(){
      try{
        const r=await fetch("/api/metadata");
        const d=await r.json();
        const raw=decodeHtml(d.nowPlaying||"").trim();
        const sep = raw.includes(" ‚Äì ")?" ‚Äì ": raw.includes(" - ")?" - ":null;
        if(sep){
          const [artist,title]=raw.split(sep);
          nowPlayingEl.innerHTML=`
            <span style="color:#fed351">Now Playing:</span>
            <span class="live-indicator"><span class="dot"></span>LIVE</span><br>
            <span style="font-weight:600;font-size:1.2em">${title}</span><br>
            <span>by ${artist}</span>`;
          const art = await getTrackArtwork(`${artist} - ${title}`);
          setArtwork(art || "Essential Radio Logo.png", !art);
        }else{
          nowPlayingEl.innerHTML=`
            <span style="color:#fed351">Now Playing:</span>
            <span class="live-indicator"><span class="dot"></span>LIVE</span><br>
            <span style="font-weight:600;font-size:1.2em">More music soon</span><br>
            <span>on Essential Radio</span>`;
          setArtwork("Essential Radio Logo.png",true);
        }
      }catch(e){
        console.error("NP fetch error:",e);
        setArtwork("Essential Radio Logo.png",true);
      }
    }

    /* --- recent tracks --- */
    const imgObserver = new IntersectionObserver(es=>{
      es.forEach(e=>{ if(e.isIntersecting){e.target.classList.add("loaded"); imgObserver.unobserve(e.target);} });
    },{threshold:.1});

    async function fetchRecent(){
      try{
        const r=await fetch("https://essentialradio.github.io/player/playout_log_rolling.json");
        const data=await r.json();
        const recent=data.filter(i=>i.Artist&&i.Title).slice(-5).reverse();

        recentList.innerHTML = await Promise.all(recent.map(async item=>{
          const time=item["Scheduled Time"]||item.time||"";
          const full=`${item.Artist} ‚Äì ${item.Title}`;
          const art=await getTrackArtwork(`${item.Artist} - ${item.Title}`) || "Essential Radio Logo.png";
          return `<li><span class="time">${time}</span><img src="${art}" alt="Cover art for ${full}" loading="lazy"><span class="info">${full}</span></li>`;
        })).then(arr=>arr.join(""));

        recentList.querySelectorAll("img").forEach(img=>imgObserver.observe(img));
      }catch(e){console.error("Recent fetch error:",e);}
    }

    /* --- kick off loops --- */
    fetchNowPlaying();  fetchRecent();
    setInterval(fetchNowPlaying,15_000);
    setInterval(fetchRecent,15_000);
  </script>
</body>
</html>
