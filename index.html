<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Security & referrer policy meta tags -->
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <title>Essential Radio Player</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />
  <style>
    html, body {
  height: 100%;
  width: 100vw;
  max-width: 100vw;
  overflow-x: hidden;
  box-sizing: border-box;
}
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 30px 0 16px 0;
  background: linear-gradient(135deg, #00818a, #7e1974);
  color: white;
  display: flex;
  justify-content: center;
  min-height: 100vh;
  box-sizing: border-box;
}
.player-wrapper {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100vw;
  max-width: 100vw;
  min-height: 100vh;
  box-sizing: border-box;
}
.logo-overhang {
  position: absolute;
  top: 0;
  left: 0;
  transform: translate(-25%, -30%);
  width: 20vw;
  min-width: 80px;
  max-width: 130px;
  z-index: 2;
  opacity: 0.97;
  pointer-events: none;
  user-select: none;
  filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.35));
}
.essential-menu-float {
  position: fixed;
  top: 14px;
  right: 8px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 110;
  background: rgba(24, 24, 24, 0.91);
  padding: 9px 8px;
  border-radius: 13px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  backdrop-filter: blur(2px);
  opacity: 0;
  animation: fadein 1s 0.4s forwards;
}
.menu-btn {
  display: block;
  min-width: 100px;
  max-width: 180px;
  padding: 10px 8px;
  background: #FFD84A;
  color: #181818;
  font-family: 'Montserrat', 'Arial', sans-serif;
  font-weight: 700;
  font-size: 1.02rem;
  border: none;
  border-radius: 9px;
  box-shadow: 0 2px 0 0 #A09C55, 0 6px 16px rgba(0,0,0,0.08);
  text-decoration: none;
  text-align: left;
  letter-spacing: 0.01em;
  transition: filter 0.13s, transform 0.11s, box-shadow 0.2s;
  cursor: pointer;
  margin-bottom: 2px;
}
.menu-btn:hover,
.menu-btn:focus {
  filter: brightness(1.1) drop-shadow(0 0 10px #ffe87c);
  box-shadow: 0 0 12px #fed351b0, 0 8px 30px rgba(0,0,0,0.08);
  transform: scale(1.045);
}
.news-btn {
  background: #FFE96B;
  color: #181818;
  border: 2px solid #fdb731;
}
.travel-btn {
  background: #FEE275;
  color: #181818;
  border: 2px solid #5ceafc;
}
.strip-container {
  display: flex;
  flex-direction: row;
  width: 98vw;
  max-width: 1100px;
  min-width: 0;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 0 18px rgba(0, 0, 0, 0.5);
  background-color: #111;
  position: relative;
  z-index: 1;
  margin-top: 50px;
}
.left-panel, .right-panel {
  width: 50%;
  min-width: 0;
  box-sizing: border-box;
  padding: 16px 10px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}
.left-panel {
  background: #111;
  align-items: center;
  text-align: center;
  border-right: 1px solid #222;
}
.right-panel {
  background: #222;
  overflow-y: auto;
  border-left: 1px solid #111;
  align-items: stretch;
}
#player-box {
  max-width: 98vw;
  width: 100%;
  margin: 0 auto;
}
button {
  background-color: #fed351;
  color: #111;
  border-radius: 7px;
  padding: 9px 18px;
  font-weight: 600;
  font-size: 17px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  user-select: none;
}
button:hover,
button:focus {
  background-color: #e5c73f;
  box-shadow: 0 0 10px #fed351cc;
  outline: none;
}
#mute-toggle {
  font-size: 16px;
  padding: 5px 10px;
  vertical-align: middle;
  margin-left: 10px;
}
#volume-container {
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
#volume-slider {
  width: 110px;
  cursor: pointer;
}
#volume-display {
  font-size: 15px;
  color: #ccc;
  min-width: 30px;
  text-align: left;
  user-select: none;
}
#onAirNow {
  margin-top: 6px;
  margin-bottom: 8px;
  text-align: center;
  max-width: 99%;
  margin-left: auto;
  margin-right: auto;
}
.pulsing-label {
  color: #ff4d4d;
  font-weight: 700;
  animation: pulseText 5s infinite;
}
@keyframes pulseText {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.1); }
}
#nowPlaying {
  margin-top: 10px;
}
#now-playing-card {
  margin-top: 14px;
  background: #1a1a1a;
  border-radius: 8px;
  padding: 11px;
  box-shadow: 0 0 8px rgba(0, 131, 138, 0.6);
  max-width: 96vw;
  font-size: 16px;
  color: white;
}
#artwork {
  margin-top: 11px;
  border-radius: 7px;
  width: 43vw;
  max-width: 220px;
  height: auto;
  object-fit: cover;
  border: 2px solid #fed351;
  box-shadow: 0 0 10px #fed35199;
  user-select: none;
  opacity: 0;
  filter: blur(10px) brightness(0.8);
  transition: opacity 0.4s, filter 0.4s;
}
#artwork.loaded {
  opacity: 1;
  filter: blur(0) brightness(1);
}
#artwork.fallback {
  filter: blur(5px) brightness(0.8);
  opacity: 0.7;
  box-shadow: 0 0 10px rgba(254, 211, 81, 0.4);
}
#weather-widget {
  background: rgba(0,0,0,0.21);
  padding: 7px 11px;
  border-radius: 9px;
  font-size: 15px;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 9px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  margin-bottom: 14px;
  width: 100%;
  max-width: 98vw;
  position: static;
  opacity: 1;
  animation: none;
  box-sizing: border-box;
}
#weather-widget img {
  width: 32px;
  height: 32px;
}
#weather-widget strong {
  color: #fed351;
  font-family: 'Montserrat', Arial, sans-serif;
  font-size: 1em;
  font-weight: bold;
  letter-spacing: 0.01em;
}
.recent-title {
  font-size: 17px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #fed351;
  user-select: none;
  margin-top: 2px;
}
ul#recent-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
ul#recent-list li {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 0;
  border-bottom: 1px solid #444;
  transition: background 0.2s;
  font-size: 13px;
}
ul#recent-list li:hover {
  background: rgba(255, 255, 255, 0.05);
}
ul#recent-list img {
  width: 25px;
  height: 25px;
  border-radius: 4px;
  object-fit: cover;
  border: 1px solid #fed351;
  box-shadow: 0 0 2px rgba(0,0,0,0.2);
  user-select: none;
  opacity: 0;
  transition: opacity 0.4s;
}
ul#recent-list img.loaded {
  opacity: 1;
}
ul#recent-list span.time {
  color: #fed351;
  font-weight: 600;
  width: 38px;
  text-align: right;
  flex-shrink: 0;
  user-select: none;
  font-size: 12px;
}
ul#recent-list span.info {
  flex: 1;
  color: white;
  font-size: 12.5px;
  user-select: none;
}
@media (max-width: 900px) {
  .strip-container {
    flex-direction: column;
    width: 99vw;
    max-width: 99vw;
  }
  .left-panel, .right-panel {
    width: 100vw;
    max-width: 99vw;
    min-width: 0;
    box-sizing: border-box;
    padding: 11px 3vw;
  }
  .right-panel {
    align-items: stretch;
  }
}
@media (max-width: 700px) {
  .logo-overhang { width: 33vw; max-width: 88px;}
  .essential-menu-float {
    width: 100vw !important;
    max-width: 100vw !important;
    position: static !important;
    margin: 0 0 5px 0;
    padding: 6px 0 2px 0;
    border-radius: 7px;
    box-shadow: none;
    background: rgba(24,24,24,0.97);
    flex-direction: row !important;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    overflow-y: hidden;
    gap: 4px !important;
    justify-content: flex-start !important;
    align-items: stretch !important;
    opacity: 1 !important;
    animation: none !important;
    z-index: 300;
  }
  .menu-btn { min-width: 90px; max-width: 120px; font-size: 0.88rem; padding: 8px 2px; }
  .strip-container, .left-panel, .right-panel { max-width: 100vw !important; }
  #weather-widget { font-size: 14px; gap: 7px; }
  #weather-widget img { width: 25px; height: 25px; }
  #artwork { width: 89vw; max-width: 170px; }
}
@keyframes fadein { to { opacity: 1; } }

  </style>
</head>
<body>
  <div class="player-wrapper">
    <img src="ERLogo2.png" alt="Essential Radio Logo" class="logo-overhang" />

    <nav class="essential-menu-float">
      <a href="https://www.essential.radio/?name=About%20Us" class="menu-btn">About Us</a>
      <a href="https://www.essential.radio/?name=Schedule" class="menu-btn">Schedule</a>
      <a href="https://www.essential.radio/?name=Listen%20Again" class="menu-btn">Listen Again</a>
      <a href="https://www.essential.radio/?name=Playlist" class="menu-btn">Playlist</a>
      <a href="https://www.essential.radio/?name=Song%20Search" class="menu-btn">Song Search</a>
      <a href="https://www.essential.radio/?name=Requests" class="menu-btn">Requests</a>
      <a href="https://www.essential.radio/?name=Contact%20Us" class="menu-btn">Contact Us</a>
      <a href="https://www.essential.radio/?name=News" class="menu-btn news-btn">News</a>
      <a href="https://www.essential.radio/?name=Travel" class="menu-btn travel-btn">Travel</a>
    </nav>

    <div class="strip-container">
      <div class="left-panel">
        <div id="onAirNow" style="text-align: right;">
          <span class="pulsing-label">ON AIR NOW</span>
          <span id="currentShow" style="font-weight: 600;">Loading...</span>
        </div>
        <div id="player-box">
          <audio id="stream" preload="none">
            <source src="https://streaming06.liveboxstream.uk/proxy/ayrshire/stream" type="audio/mpeg" />
          </audio>
          <button id="play-toggle">‚ñ∂Ô∏è Play Essential Radio</button>
          <div id="volume-container">
            <label for="volume-slider">Volume:</label>
            <input type="range" id="volume-slider" min="0" max="100" value="100" />
            <span id="volume-display">100%</span>
            <button id="mute-toggle">üîä</button>
          </div>
          <div id="now-playing-card">
            <div id="now-playing">Loading current track‚Ä¶</div>
          </div>
          <img id="artwork" src="Essential Radio Logo.png" alt="Artwork" class="loaded" />
        </div>
      </div>
      <div class="right-panel">
        <div id="weather-widget">
          <img id="weather-icon" src="" alt="Weather" width="36" height="36" />
          <div>
            <strong>Ayrshire Weather</strong><br>
            <span id="weather-text" style="vertical-align: middle;">Loading weather‚Ä¶</span>
          </div>
        </div>
        <div class="recent-title">Recently Played</div>
        <ul id="recent-list"></ul>
      </div>
    </div>
  </div>

  <!-- WEATHER -->
  <script>
    async function fetchWeather() {
      const API_KEY = 'e4a309c7e76f09b85a2ff7d34305505f';
      const url = `https://api.openweathermap.org/data/2.5/weather?q=Kilmarnock,GB&units=metric&appid=${API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const iconCode = data.weather[0].icon;
        const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
        const temp = Math.round(data.main.temp);
        const desc = data.weather[0].description;
        document.getElementById("weather-icon").src = iconUrl;
        document.getElementById("weather-icon").alt = desc;
        document.getElementById("weather-text").innerText = `${desc.charAt(0).toUpperCase() + desc.slice(1)}, ${temp}¬∞C`;
      } catch (e) {
        document.getElementById("weather-text").innerText = "Weather unavailable";
      }
    }
    fetchWeather();
    setInterval(fetchWeather, 15 * 60 * 1000);
  </script>

  <!-- SCHEDULE -->
  <script>
    async function fetchSchedule() {
      try {
        const res = await fetch("https://essentialradio.github.io/player/schedule.json");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        return null;
      }
    }
    function getCurrentShow(schedule) {
      const now = new Date();
      const day = now.toLocaleString("en-GB", { weekday: "long" });
      const shows = schedule && schedule[day];
      if (!shows) return "No schedule available";
      const nowMins = now.getHours() * 60 + now.getMinutes();
      for (const show of shows) {
        const [sh, sm] = show.start.split(":").map(Number);
        const [eh, em] = show.end.split(":").map(Number);
        let start = sh * 60 + sm;
        let end = eh * 60 + em;
        if (end === 0 && start > 0) end = 1440;
        if (nowMins >= start && nowMins < end) {
          return show.title;
        }
      }
      return "Off Air";
    }
    async function updateOnAirNow() {
      const schedule = await fetchSchedule();
      const fullShow = schedule ? getCurrentShow(schedule) : "Schedule unavailable";
      const el = document.getElementById("currentShow");
      if (fullShow.includes(" with ")) {
        const [title, presenter] = fullShow.split(" with ");
        el.innerHTML = `
          <span class="show-title">${title.trim()}</span>
          <span class="show-presenter">with ${presenter.trim()}</span>`;
      } else {
        el.textContent = fullShow;
      }
    }
    updateOnAirNow();
    setInterval(updateOnAirNow, 60000);
  </script>

  <!-- PLAYER & ARTWORK & RECENT LOGIC -->
  <script>
    const audio = document.getElementById('stream');
    const playBtn = document.getElementById('play-toggle');
    const muteBtn = document.getElementById('mute-toggle');
    const volumeSlider = document.getElementById('volume-slider');
    if (window.innerWidth <= 768) {
      volumeSlider.disabled = true;
      muteBtn.disabled = true;
    }
    const volumeDisplay = document.getElementById('volume-display');
    const nowPlaying = document.getElementById('now-playing');
    const artworkImg = document.getElementById('artwork');
    const observer = new IntersectionObserver(entries => {
      for (const e of entries) {
        if (e.isIntersecting) {
          e.target.classList.add('loaded');
          observer.unobserve(e.target);
        }
      }
    }, { threshold: 0.1 });
    let isPlaying = false, lastVolume = 1;
    playBtn.addEventListener('click', () => {
      if (!isPlaying) {
        audio.load();
        audio.play().catch(() => {});
        playBtn.textContent = '‚è∏ Pause';
        isPlaying = true;
      } else {
        audio.pause();
        playBtn.textContent = '‚ñ∂Ô∏è Play Essential Radio';
        isPlaying = false;
      }
    });
    volumeSlider.addEventListener('input', () => {
      const vol = volumeSlider.value / 100;
      audio.volume = vol;
      volumeDisplay.textContent = `${volumeSlider.value}%`;
      muteBtn.textContent = vol === 0 ? 'üîá' : vol < 0.5 ? 'üîà' : 'üîä';
    });
    muteBtn.addEventListener('click', () => {
      if (!audio.muted) {
        audio.muted = true;
        muteBtn.textContent = 'üîá';
        volumeDisplay.textContent = 'Muted';
      } else {
        audio.muted = false;
        muteBtn.textContent = audio.volume < 0.5 ? 'üîà' : 'üîä';
        volumeDisplay.textContent = `${volumeSlider.value}%`;
      }
    });
    function showMoreMusicSoon() {
      nowPlaying.innerHTML = `
        <span style="color:#fed351;">Now Playing:</span>
        <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>
        <span style="color:white;font-weight:600;font-size:1.2em;">More music soon</span><br/>
        <span style="color:white;">on Essential Radio</span>`;
      document.title = `Essential Radio: More music soon`;
      applyFallbackImmediate();
    }
    let currentTrackID = null;
    let songHasEnded = false;
    let trackEndTimeout = null;
    async function fetchNowPlaying() {
      try {
        const res = await fetch('https://player-green.vercel.app/api/metadata', { cache: 'no-store' });
        const data = await res.json();
        const decode = str => {
          const t = document.createElement('textarea');
          t.innerHTML = str;
          return t.value;
        };
        const raw = decode(data.nowPlaying || '').trim();
        let artist = '', title = '';
        const sep = raw.includes(' ‚Äì ') ? ' ‚Äì ' : raw.includes(' - ') ? ' - ' : null;
        if (sep) {
          [artist, title] = raw.split(sep).map(s => s.trim());
        } else {
          showMoreMusicSoon();
          return;
        }
        currentTrackID = `${artist} ‚Äì ${title}`;
        songHasEnded = false;
        // Display current track
        nowPlaying.innerHTML = `
          <span style="color:#fed351;">Now Playing:</span>
          <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>
          <span style="color:white;font-weight:600;font-size:1.2em;">${title}</span><br/>
          <span style="color:white;">by ${artist}</span>`;
        document.title = `Essential Radio: ${artist} ‚Äì ${title}`;
        fetchArtwork(`${artist} - ${title}`);
        // Fetch timing info from latestTrack.json
        const latestRes = await fetch('https://essentialradio.github.io/player/latestTrack.json?_=' + Date.now());
        const latest = await latestRes.json();
        if (!latest || !latest.artist || !latest.title || !latest.duration || !latest.startTime) {
          return;
        }
        if (
          latest.artist.toLowerCase() !== artist.toLowerCase() ||
          latest.title.toLowerCase() !== title.toLowerCase()
        ) {
          return;
        }
        const startTime = new Date(latest.startTime);
        const durationMs = latest.duration * 1000;
        const endTime = new Date(startTime.getTime() + durationMs);
        const now = new Date();
        const timeRemaining = endTime - now;
        if (trackEndTimeout) clearTimeout(trackEndTimeout);
        if (timeRemaining <= 0) {
          showMoreMusicSoon();
          songHasEnded = true;
          currentTrackID = null;
        } else {
          trackEndTimeout = setTimeout(() => {
            showMoreMusicSoon();
            songHasEnded = true;
            currentTrackID = null;
          }, timeRemaining);
        }
      } catch (e) {
        showMoreMusicSoon();
        currentTrackID = null;
        songHasEnded = false;
      }
    }
    async function fetchRecentFromGitHub() {
      try {
        const baseUrl = 'https://essentialradio.github.io/player/playout_log_rolling.json';
        const res = await fetch(`${baseUrl}?_=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const recentItems = data
          .filter(item => {
            const name = `${item.Artist} ‚Äì ${item.Title}`;
            return item.Artist && item.Title && (songHasEnded || name !== currentTrackID);
          })
          .slice(-5)
          .reverse();
        const entries = await Promise.all(recentItems.map(async item => {
          const time = item['Scheduled Time'] || item.time || '';
          const name = `${item.Artist} ‚Äì ${item.Title}`;
          const art = await getTrackArtwork(name) || 'Essential Radio Logo.png';
          return `
            <li>
              <span class="time">${time}</span>
              <img src="${art}"
                   alt="Cover for ${name}"
                   loading="lazy" />
              <span class="info">${name}</span>
            </li>`;
        }));
        const list = document.getElementById('recent-list');
        list.innerHTML = entries.join('');
        document.querySelectorAll('#recent-list img').forEach(img => observer.observe(img));
      } catch (e) {}
    }
    async function fetchArtwork(trackName) {
      artworkImg.src = 'Essential Radio Logo.png';
      artworkImg.classList.remove('loaded', 'fallback');
      try {
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(trackName)}&limit=1`);
        const js = await res.json();
        if (js.results[0]?.artworkUrl100) {
          const url = js.results[0].artworkUrl100.replace('100x100', '300x300');
          artworkImg.onload = () => artworkImg.classList.add('loaded');
          artworkImg.onerror = applyFallbackImmediate;
          artworkCache[trackName] = url;
          artworkImg.src = url;
          return;
        }
      } catch {}
      const safe = trackName
        .replace(/\s*\(.*?\)/g, '')
        .replace(/[^a-zA-Z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '_');
      const [artist, title] = safe.split('_-_');
      const autoUrl = `https://cdn.autopo.st/images/coverart/${artist?.[0]?.toLowerCase()||'a'}/${artist}_${title}.jpg`;
      try {
        const head = await fetch(autoUrl, { method: 'HEAD' });
        if (head.ok) {
          artworkImg.onload = () => artworkImg.classList.add('loaded');
          artworkImg.onerror = applyFallbackImmediate;
          artworkImg.src = autoUrl;
          return;
        }
      } catch {}
      applyFallbackImmediate();
    }
    function applyFallbackImmediate() {
      artworkImg.src = 'Essential Radio Logo.png';
      artworkImg.classList.remove('loaded');
      artworkImg.classList.add('fallback');
    }
    const artworkCache = {};
    async function getTrackArtwork(query) {
      if (artworkCache[query]) return artworkCache[query];
      try {
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&limit=1`);
        const d = await res.json();
        if (d.results[0]?.artworkUrl100) {
          return d.results[0].artworkUrl100.replace('100x100', '300x300');
        }
      } catch {}
      return '';
    }
    fetchNowPlaying();
    fetchRecentFromGitHub();
    setInterval(fetchNowPlaying, 15000);
    setInterval(fetchRecentFromGitHub, 15000);
  </script>
</body>
</html>
