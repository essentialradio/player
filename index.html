import fs from 'fs';
import path from 'path';
import fetch from 'node-fetch';
import { getCloseMatches } from 'string-similarity';

const playoutPath = path.join(process.cwd(), 'playout_log_rolling.json');

export async function GET() {
  try {
    const raw = fs.readFileSync(playoutPath, 'utf8');
    const data = JSON.parse(raw);

    const entries = Array.isArray(data) ? data : [];
    const now = Date.now();

    const recent = entries.filter(e => now - new Date(e.startTime).getTime() < 45 * 60 * 1000);
    const nowPlayingEntry = recent.find(e => e.isCurrent || e.hasPlayed);
    const nextEntry = entries.find(e => !e.hasPlayed && !e.isCurrent);

    const trackTitle = nowPlayingEntry?.title || 'Unknown Track';
    const artist = trackTitle.split(' - ')[0]?.trim();
    const title = trackTitle.split(' - ')[1]?.trim();

    const artwork = await getArtwork(artist, title);

    return Response.json({
      nowPlaying: trackTitle,
      recentlyPlayed: recent.map(e => e.title),
      nextToPlay: nextEntry?.title || null,
      artwork
    });
  } catch (error) {
    console.error('Metadata fetch failed:', error);
    return Response.json({
      nowPlaying: 'Unknown Track',
      recentlyPlayed: [],
      nextToPlay: null,
      artwork: null,
      error: 'Failed to load playout data'
    });
  }
}

async function getArtwork(artist, title) {
  const query = encodeURIComponent(`${artist} ${title}`);

  // iTunes
  try {
    const iTunesRes = await fetch(`https://itunes.apple.com/search?term=${query}&entity=song&limit=1`);
    const iTunesJson = await iTunesRes.json();
    if (iTunesJson.results?.length) return iTunesJson.results[0].artworkUrl100.replace('100x100', '300x300');
  } catch (e) {}

  // Deezer
  try {
    const deezerRes = await fetch(`https://api.deezer.com/search?q=${query}`);
    const deezerJson = await deezerRes.json();
    if (deezerJson.data?.length) return deezerJson.data[0].album.cover_medium;
  } catch (e) {}

  // Last.fm (requires demo key or your own API key)
  try {
    const lastfmRes = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.search&track=${encodeURIComponent(title)}&artist=${encodeURIComponent(artist)}&api_key=demo&format=json`);
    const lastfmJson = await lastfmRes.json();
    const match = lastfmJson.results?.trackmatches?.track?.[0];
    if (match?.image?.length) return match.image.pop()['#text'];
  } catch (e) {}

  return null;
}
