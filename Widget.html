<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Essential Radio Widget (Simple iTunes Lookup)</title>
  <style>
    :root { --bg:#111; --fg:#fff; --muted:#cfcfcf; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h2 { margin: 10px; font-size: 16px; font-weight: 700; }
    #now-playing, #recently-played { padding: 8px; }
    .track { display: flex; align-items: center; gap: 10px; padding: 8px;
      border-radius: 8px; background: #1b1b1b; }
    .art { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background:#222; }
    .meta { display: grid; gap: 2px; }
    .artist { font-weight: 700; font-size: 14px; }
    .title { font-size: 13px; color: var(--muted); }
    .recent-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px;
      border-radius: 8px; background: #151515; margin-bottom: 6px; }
    .recent-art { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background:#222; }
    .recent-meta { display: grid; gap: 1px; }
  </style>
</head>
<body>
  <div id="now-playing" aria-live="polite" aria-atomic="true">
    <h2>Now Playing</h2>
    <div class="track" id="current-track">
      <img class="art" src="ERLogo2.png" alt="Album artwork" referrerpolicy="no-referrer" />
      <div class="meta">
        <div class="artist" id="np-artist">Loadingâ€¦</div>
        <div class="title" id="np-title"></div>
      </div>
    </div>
  </div>

  <div id="recently-played">
    <h2>Recently Played</h2>
    <div id="recent-list" aria-live="polite" aria-atomic="false"></div>
  </div>

  <script>
    const FALLBACK_IMG = "ERLogo2.png"; // station logo fallback

    // Single shared lookup used by both sections
    async function fetchArtworkFromItunes(artist, title) {
      const queryText = `${artist || ""} ${title || ""}`.trim();
      if (!queryText) return FALLBACK_IMG;
      const q = encodeURIComponent(queryText);
      try {
        const res = await fetch(`https://itunes.apple.com/search?term=${q}&entity=song&limit=1&country=gb`);
        if (!res.ok) throw new Error("iTunes HTTP " + res.status);
        const data = await res.json();
        if (data.results && data.results.length) {
          const raw = data.results[0].artworkUrl100 || data.results[0].artworkUrl60 || data.results[0].artworkUrl30 || "";
          return raw ? raw.replace(/\/(\d+x\d+)bb\//, "/600x600bb/") : FALLBACK_IMG;
        }
      } catch (_) {}
      return FALLBACK_IMG;
    }

    const norm = s => (s || "").toString().trim().toLowerCase();

    async function getLatestTrack() {
      const r = await fetch(`/api/latestTrack?_=${Date.now()}`);
      if (!r.ok) throw new Error("latestTrack fetch failed " + r.status);
      return r.json();
    }

    async function loadNowPlaying() {
      try {
        const t = await getLatestTrack();
        const artist = t?.artist || "";
        const title = t?.title || "";
        const art = await fetchArtworkFromItunes(artist, title);
        document.querySelector("#current-track .art").src = art;
        document.getElementById("np-artist").textContent = artist || "Unknown Artist";
        document.getElementById("np-title").textContent = title || "Unknown Title";
      } catch {
        document.querySelector("#current-track .art").src = FALLBACK_IMG;
        document.getElementById("np-artist").textContent = "Unavailable";
        document.getElementById("np-title").textContent = "";
      }
    }

    async function loadRecentlyPlayed(limit = 5) {
      try {
        // Get current track to filter it out (kept as per your earlier request)
        let current = null;
        try { current = await getLatestTrack(); } catch {}
        const ca = norm(current?.artist), ct = norm(current?.title);

        const res = await fetch(`/api/recentlyPlayed?_=${Date.now()}`);
        if (!res.ok) throw new Error("recentlyPlayed fetch failed " + res.status);
        let items = await res.json();
        if (!Array.isArray(items)) items = [];

        // Exclude the current track if present
        if (ca || ct) items = items.filter(x => !(norm(x?.artist) === ca && norm(x?.title) === ct));

        // Cap list
        items = items.slice(0, limit);

        const container = document.getElementById("recent-list");
        container.innerHTML = "";

        // Use the SAME lookup helper as Now Playing
        const arts = await Promise.all(items.map(x => fetchArtworkFromItunes(x?.artist || "", x?.title || "")));

        items.forEach((x, i) => {
          const art = arts[i] || FALLBACK_IMG;
          const artist = x?.artist || "Unknown Artist";
          const title = x?.title || "Unknown Title";
          const row = document.createElement("div");
          row.className = "recent-item";
          row.innerHTML = `
            <img class="recent-art" src="${art}" alt="Album artwork" referrerpolicy="no-referrer">
            <div class="recent-meta">
              <div class="artist">${artist}</div>
              <div class="title">${title}</div>
            </div>
          `;
          container.appendChild(row);
        });
      } catch {
        document.getElementById("recent-list").innerHTML = "<div class='title'>No recent tracks available.</div>";
      }
    }

    // Initial loads
    loadNowPlaying();
    loadRecentlyPlayed(5);

    // Polling
    setInterval(loadNowPlaying, 20000);
    setInterval(() => loadRecentlyPlayed(5), 60000);
  </script>
</body>
</html>
