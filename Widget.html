<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio Widget ‚Äì 480px Fit (Fixed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --gold:#fed351; --ink:#111; --night:#191c29; --pane:#21233c; }
    #erw, #erw * { box-sizing: border-box; }
    body { margin: 0; background: transparent; }
    #erw { font-family: 'Inter', sans-serif; color: #fff; }
    #erw .widget-shell { background: var(--night); border-radius: 20px; box-shadow: 0 4px 24px #0005; overflow: hidden; }

    /* Desktop tuned for 480px iframe */
    #erw .desktop { display: flex; width: 100%; height: 460px; }
    #erw .left {
      width: 250px; min-width: 210px; background: var(--pane); height: 100%;
      display: flex; flex-direction: column; align-items: center;
      padding: 12px 12px 10px 12px; border-right: 2px solid #fed35144;
    }
    #erw .logo { width: 110px; border-radius: 16px; margin-bottom: 4px; user-select: none; }
    #erw .on-air-label { display:inline-flex; align-items:center; gap:8px; color:#ff4d4d; font-weight:700; font-size:.92em; margin:2px 0 0 0; }
    #erw .live-dot { width:10px; height:10px; border-radius:50%; background:#ff4d4d; animation: erw-pulse 1.2s infinite; }
    @keyframes erw-pulse { 0%,100%{opacity:.2; transform:scale(1)} 50%{opacity:1; transform:scale(1.4)} }

    #erw #currentShow { margin: 2px 0 6px 0; text-align:center; font-weight:600; }

    #erw #artwork {
      width: 128px; height: 128px; border-radius: 12px; border: 3px solid var(--gold);
      object-fit: cover; background:#222; box-shadow: 0 2px 16px #fed35133;
      margin: 4px 0 8px 0; opacity: 0; filter: blur(10px) brightness(.9);
      transition: opacity .4s ease-in-out, filter .4s ease-in-out;
    }
    #erw #artwork.loaded { opacity: 1; filter: blur(0) brightness(1); }
    #erw #artwork.fallback { filter: blur(5px) brightness(.85); opacity: .85; box-shadow: 0 0 10px rgba(254,211,81,.35); }

    /* Now Playing (fills via index logic) */
    #erw #now-playing { text-align: center; line-height: 1.45; font-size: .98em; }
    #erw #now-playing .live-indicator { display:inline-flex; align-items:center; gap:6px; font-weight:700; color:#ff4d4d; font-size:.92em; margin-left:8px; }
    #erw #now-playing .live-indicator .dot { width:10px; height:10px; border-radius:50%; background:#ff4d4d; animation: erw-pulse 1.2s infinite; }

    #erw .right { flex:1; display:flex; flex-direction:column; padding: 12px 14px 10px 16px; height:100%; }
    #erw .recent-title { font-size: 1.02em; font-weight: 600; margin: 0 0 6px 0; color: var(--gold); }
    #erw ul.recent { list-style: none; margin: 0; padding: 0; }
    #erw ul.recent li {
      display: grid; grid-template-columns: 38px 1fr auto; align-items: center; gap: 8px;
      padding: 6px 0; border-bottom: 1px solid #28284b; font-size: 0.95em;
    }
    #erw ul.recent li:last-child { border-bottom: none; }
    #erw ul.recent img.thumb { width:38px; height:38px; border-radius: 7px; object-fit: cover; border: 2px solid var(--gold); background:#222; opacity:0; transition:opacity .4s; }
    #erw ul.recent img.thumb.loaded { opacity: 1; }
    #erw ul.recent span.info { color:#fff; font-size:.95em; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    #erw ul.recent span.time { color: var(--gold); font-size:.88em; width:48px; text-align:right; }

    #erw .upnext { display:flex; align-items:center; gap:8px; background:#21233c; border:1px solid #2a2e55; border-radius:12px; padding: 8px 10px; margin: 6px 0 8px; }
    #erw .upnext .badge { font-weight:700; color:#111; background: var(--gold); border-radius: 999px; padding: 2px 8px; font-size: .82em; }
    #erw .upnext .text { color:#fff; font-size:.94em; }
    #erw .upnext .time { color: var(--gold); font-weight:600; margin-left:auto; font-size:.9em; }

    #erw .audio-controls { display:flex; gap:8px; align-items:center; justify-content:center; background:#1c2033; border:1px solid #262a46; border-radius:12px; padding:8px; }
    #erw #play-toggle, #erw #mute-toggle { background:var(--gold); color:#111; border:none; border-radius:7px; padding:6px 12px; font-size:1em; font-weight:700; cursor:pointer; }
    #erw #play-toggle:hover, #erw #mute-toggle:hover { filter:brightness(1.05); }
    #erw #volume-slider { width: 110px; }

    #erw .cta-wrap { margin-top: auto; display:flex; justify-content:center; }
    #erw .cta { display:inline-block; text-decoration:none; background: linear-gradient(180deg, var(--gold), #f2c22a); color:#111; font-weight:800; padding:8px 14px; border-radius:12px; border:2px solid #11100022; box-shadow:0 6px 20px rgba(254,211,81,.25); font-size:.98em; }

    /* Mobile */
    #erw .mobile { display:none; width:100%; }
    @media (max-width:700px){ #erw .desktop{display:none;} #erw .mobile{display:block;} }
  </style>
</head>
<body>
  <div id="erw">
    <div class="widget-shell desktop">
      <div class="left">
        <img src="ERLogo2.png" class="logo" alt="Essential Radio Logo" />
        <div class="on-air-label"><span class="live-dot"></span>ON AIR NOW</div>
        <div id="currentShow">Loading‚Ä¶</div>

        <img id="artwork" src="Essential Radio Logo.png" alt="Artwork" class="fallback" />
        <div id="now-playing">Loading‚Ä¶</div>
      </div>

      <div class="right">
        <div class="block">
          <div class="recent-title">Recently Played</div>
          <ul id="recent-list" class="recent"></ul>
        </div>

        <div class="block">
          <div class="upnext">
            <span class="badge">Up next</span>
            <span class="text" id="upnext-text">Loading‚Ä¶</span>
            <span class="time" id="upnext-time"></span>
          </div>
        </div>

        <div class="block">
          <audio id="stream" preload="none">
            <source src="https://streaming06.liveboxstream.uk/proxy/ayrshire/stream" type="audio/mpeg" />
          </audio>
          <div class="audio-controls">
            <button id="play-toggle">‚ñ∂Ô∏è Play</button>
            <input id="volume-slider" type="range" min="0" max="100" value="100" />
            <button id="mute-toggle">üîä</button>
          </div>
        </div>

        <div class="cta-wrap">
          <a class="cta" href="https://www.essential.radio/" target="_blank" rel="noopener">Go to the Essential Radio website</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- Schedule / On-Air (same as index) ---------------- */
    async function fetchSchedule() {
      try {
        const res = await fetch("https://essentialradio.github.io/player/schedule.json");
        if (!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      } catch(e) { return null; }
    }
    function getCurrentShow(schedule) {
      const now = new Date();
      const day = now.toLocaleString("en-GB", { weekday: "long" });
      const shows = schedule && schedule[day];
      if (!shows) return "Off Air";
      const m = now.getHours()*60 + now.getMinutes();
      for (const show of shows) {
        const [sh,sm] = show.start.split(":").map(Number);
        const [eh,em] = show.end.split(":").map(Number);
        let s = sh*60+sm, e = eh*60+em; if(e===0 && s>0) e = 1440;
        if (m>=s && m<e) return show.title;
      }
      return "Off Air";
    }
    function renderShow(el, show) {
      if (!el) return;
      if (show.includes(" with ")) {
        const [t, p] = show.split(" with ");
        el.innerHTML = '<span class="show-title">'+t.trim()+'</span><br><span class="show-presenter">with '+p.trim()+'</span>';
      } else {
        el.textContent = show;
      }
    }
    async function updateOnAirNow(){
      const schedule = await fetchSchedule();
      const fullShow = schedule ? getCurrentShow(schedule) : "Off Air";
      renderShow(document.getElementById("currentShow"), fullShow);
    }
    updateOnAirNow(); setInterval(updateOnAirNow, 60_000);

    /* ---------------- Audio: mirror index behaviour (no auto-reconnect) ---------------- */
    const audio = document.getElementById('stream');
    const playBtn = document.getElementById('play-toggle');
    const muteBtn = document.getElementById('mute-toggle');
    const volumeSlider = document.getElementById('volume-slider');
    let isPlaying = false;

    playBtn.addEventListener('click', () => {
      if (!isPlaying) {
        audio.load();
        audio.play().catch(()=>{});
        playBtn.textContent = '‚è∏ Pause';
        isPlaying = true;
      } else {
        audio.pause();
        playBtn.textContent = '‚ñ∂Ô∏è Play';
        isPlaying = false;
      }
    });
    volumeSlider.addEventListener('input', () => {
      const vol = volumeSlider.value / 100;
      audio.volume = vol;
      muteBtn.textContent = vol === 0 ? 'üîá' : vol < 0.5 ? 'üîà' : 'üîä';
    });
    muteBtn.addEventListener('click', () => {
      if (!audio.muted) { audio.muted = true; muteBtn.textContent='üîá'; }
      else { audio.muted = false; muteBtn.textContent = audio.volume < 0.5 ? 'üîà' : 'üîä'; }
    });

    /* ---------------- Artwork helpers (index logic) ---------------- */
    const artworkImg = document.getElementById('artwork');
    function applyFallbackImmediate() {
      artworkImg.src = 'Essential Radio Logo.png';
      artworkImg.classList.remove('loaded');
      artworkImg.classList.add('fallback');
    }

    const artworkCache = {};
    async function fetchArtwork(trackName) {
      artworkImg.src = 'Essential Radio Logo.png';
      artworkImg.classList.remove('loaded','fallback');
      try {
        const res = await fetch('https://itunes.apple.com/search?term='+encodeURIComponent(trackName)+'&limit=1');
        const js = await res.json();
        if (js.results[0]?.artworkUrl100) {
          const url = js.results[0].artworkUrl100.replace('100x100','300x300');
          artworkImg.onload = () => artworkImg.classList.add('loaded');
          artworkImg.onerror = applyFallbackImmediate;
          artworkCache[trackName] = url;
          artworkImg.src = url;
          return;
        }
      } catch {}
      const safe = trackName.replace(/\\s*\\(.*?\\)/g,'').replace(/[^a-zA-Z0-9\\s-]/g,'').trim().replace(/\\s+/g,'_');
      const parts = safe.split('_-_');

      let artistPart = parts[0] || safe.split('_')[0] || 'a';
      let titlePart  = parts[1] || safe.split('_').slice(1).join('_') || '';

      const autoUrl = `https://cdn.autopo.st/images/coverart/${artistPart[0]?.toLowerCase()||'a'}/${artistPart}_${titlePart}.jpg`;
      try {
        const head = await fetch(autoUrl, { method:'HEAD' });
        if (head.ok) {
          artworkImg.onload = () => artworkImg.classList.add('loaded');
          artworkImg.onerror = applyFallbackImmediate;
          artworkImg.src = autoUrl;
          return;
        }
      } catch {}
      applyFallbackImmediate();
    }

    async function getTrackArtwork(query) {
      if (artworkCache[query]) return artworkCache[query];
      try {
        const res = await fetch('https://itunes.apple.com/search?term='+encodeURIComponent(query)+'&limit=1');
        const d = await res.json();
        if (d.results[0]?.artworkUrl100) {
          return d.results[0].artworkUrl100.replace('100x100','300x300');
        }
      } catch {}
      return '';
    }

    /* ---------------- Now Playing (EXACT parsing & timing from index) ---------------- */
    const nowPlayingEl = document.getElementById('now-playing');
    let currentTrackID = null;
    let songHasEnded = false;
    let trackEndTimeout = null;

    function showMoreMusicSoon() {
      nowPlayingEl.innerHTML = `
        <span style="color:#fed351;">Now Playing:</span>
        <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>
        <span style="color:white;font-weight:600;font-size:1.1em;">More music soon</span><br/>
        <span style="color:white;">on Essential Radio</span>`;
      document.title = 'Essential Radio: More music soon';
      applyFallbackImmediate();
    }

    async function fetchNowPlaying() {
      try {
        const res = await fetch('https://player-green.vercel.app/api/metadata', { cache: 'no-store' });
        const data = await res.json();

        const decode = str => { const t=document.createElement('textarea'); t.innerHTML = str || ''; return t.value; };
        const raw = decode(data.nowPlaying || '').trim();
        let artist = '', title = '';
        const sep = raw.includes(' ‚Äì ') ? ' ‚Äì ' : (raw.includes(' - ') ? ' - ' : null);
        if (!sep) { showMoreMusicSoon(); return; }
        [artist, title] = raw.split(sep).map(s => s.trim());

        currentTrackID = `${artist} ‚Äì ${title}`;
        songHasEnded = false;

        nowPlayingEl.innerHTML = `
          <span style="color:#fed351;">Now Playing:</span>
          <span class="live-indicator"><span class="dot"></span>LIVE</span><br/>
          <span style="color:white;font-weight:600;font-size:1.1em;">${title}</span><br/>
          <span style="color:white;">by ${artist}</span>`;
        document.title = \`Essential Radio: \${artist} ‚Äì \${title}\`;
        fetchArtwork(\`\${artist} - \${title}\`);

        const latestRes = await fetch('https://essentialradio.github.io/player/latestTrack.json?_=' + Date.now());
        const latest = await latestRes.json();
        if (!latest || !latest.artist || !latest.title || !latest.duration || !latest.startTime) return;
        if (latest.artist.toLowerCase() !== artist.toLowerCase() || latest.title.toLowerCase() !== title.toLowerCase()) return;

        const startTime = new Date(latest.startTime);
        const endTime = new Date(startTime.getTime() + latest.duration * 1000);
        const now = new Date();
        const remaining = endTime - now;

        if (trackEndTimeout) clearTimeout(trackEndTimeout);
        if (remaining <= 0) {
          showMoreMusicSoon();
          songHasEnded = true;
          currentTrackID = null;
        } else {
          trackEndTimeout = setTimeout(() => {
            showMoreMusicSoon();
            songHasEnded = true;
            currentTrackID = null;
          }, remaining);
        }
      } catch (e) {
        showMoreMusicSoon();
        currentTrackID = null;
        songHasEnded = false;
      }
    }

    /* ---------------- Recently Played (index logic & 5 items, no scroll) ---------------- */
    const io = new IntersectionObserver(entries => { for (const e of entries) { if (e.isIntersecting) { e.target.classList.add('loaded'); io.unobserve(e.target); } } }, { threshold: 0.1 });

    async function fetchRecentFromGitHub() {
      try {
        const baseUrl = 'https://essentialradio.github.io/player/playout_log_rolling.json';
        const res = await fetch(baseUrl + '?_=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        const recentItems = data
          .filter(item => {
            const name = \`\${item.Artist} ‚Äì \${item.Title}\`;
            return item.Artist && item.Title && (songHasEnded || name !== currentTrackID);
          })
          .slice(-5) /* exactly five */
          .reverse();

        const entries = await Promise.all(recentItems.map(async item => {
          const time = item['Scheduled Time'] || item.time || '';
          const name = \`\${item.Artist} ‚Äì \${item.Title}\`;
          const art = await getTrackArtwork(name) || 'Essential Radio Logo.png';
          return \`
            <li>
              <img class="thumb" src="\${art}" alt="Cover for \${name}" />
              <span class="info">\${name}</span>
              <span class="time">\${time}</span>
            </li>\`;
        }));

        const list = document.getElementById('recent-list');
        list.innerHTML = entries.join('');
        document.querySelectorAll('#recent-list img.thumb').forEach(img => io.observe(img));
      } catch (e) { /* silent */ }
    }

    /* ---------------- Up Next (lightweight reuse of schedule) ---------------- */
    function minutes(hm) { const [h,m]=hm.split(':').map(Number); return h*60+m; }
    function getCurrentAndNext(schedule) {
      const now = new Date(), nm = now.getHours()*60 + now.getMinutes();
      const dayName = now.toLocaleString('en-GB', { weekday:'long' });
      const idx = now.getDay(); const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const today = schedule?.[dayName] || [];
      let cur=null, next=null;
      for (let i=0;i<today.length;i++) {
        const s = minutes(today[i].start), e = minutes(today[i].end||'24:00'); const end = (e===0 && s>0)?1440:e;
        if (nm>=s && nm<end) { cur=today[i]; next=today[i+1]||null; break; }
        if (nm < s && !next) next = today[i];
      }
      if (!next) { const nextDay = days[(idx+1)%7]; const list = schedule?.[nextDay]||[]; next = list[0]||null; if (next) next._tomorrow = true; }
      return {cur,next};
    }
    async function updateUpNext(){
      const schedule = await fetchSchedule(); if(!schedule) return;
      const { next } = getCurrentAndNext(schedule);
      const upText = (next?.title) ? next.title : 'More music';
      const timeStr = (next?.start) ? next.start : '';
      const label = next?._tomorrow ? 'Tomorrow' : 'Today';
      document.getElementById('upnext-text').textContent = upText;
      document.getElementById('upnext-time').textContent = timeStr ? (label+' ‚Ä¢ '+timeStr) : '';
    }

    /* Kick-off & timers (same cadence as index) */
    fetchNowPlaying(); fetchRecentFromGitHub(); updateUpNext();
    setInterval(fetchNowPlaying, 15000);
    setInterval(fetchRecentFromGitHub, 15000);
    setInterval(updateUpNext, 60000);
  </script>
</body>
</html>
