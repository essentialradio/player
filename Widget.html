<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio Widget</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #00818a, #7e1974);
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .widget-container {
      background: #191c29;
      border-radius: 18px;
      box-shadow: 0 2px 16px #0006;
      width: 100%;
      max-width: 350px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .logo {
      width: 78px;
      margin-bottom: 14px;
      border-radius: 13px;
      box-shadow: 0 0 9px #fed35166;
      background: #fed351;
      object-fit: contain;
    }
    .on-air-now {
      color: #fed351;
      font-weight: 700;
      letter-spacing: 0.04em;
      font-size: 1em;
      margin-bottom: 2px;
      text-align: center;
    }
    #currentShow {
      font-size: 1.06em;
      font-weight: 600;
      text-align: center;
      margin-bottom: 12px;
    }
    #currentShow .show-presenter {
      font-weight: 400;
      font-size: 0.94em;
      font-style: italic;
      display: block;
      opacity: 0.9;
    }
    .audio-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      width: 100%;
      justify-content: center;
    }
    #play-toggle, #mute-toggle {
      background: #fed351;
      color: #111;
      border: none;
      border-radius: 7px;
      padding: 7px 16px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #play-toggle:hover, #mute-toggle:hover {
      background: #ffe67c;
    }
    #volume-slider {
      width: 68px;
    }
    .now-playing-box {
      background: #24243e;
      border-radius: 11px;
      width: 100%;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 13px;
    }
    #artwork {
      width: 78px;
      height: 78px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 2px solid #fed351;
      background: #222;
      object-fit: cover;
    }
    #now-playing {
      font-size: 1.06em;
      font-weight: 600;
      color: #fed351;
      text-align: center;
    }
    #now-playing-artist {
      font-size: 1em;
      font-weight: 400;
      color: #fff;
      text-align: center;
      margin-top: 2px;
    }
    .recent-title {
      font-size: 1em;
      font-weight: 600;
      margin: 8px 0 3px 0;
      color: #fed351;
      text-align: center;
    }
    ul#recent-list {
      list-style: none;
      margin: 0;
      padding: 0;
      width: 100%;
      max-height: 100px;
      overflow-y: auto;
    }
    ul#recent-list li {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 0;
      border-bottom: 1px solid #2d2d45;
      font-size: 0.96em;
    }
    ul#recent-list img {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #fed351;
      background: #222;
    }
    ul#recent-list span.info {
      color: #fff;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    ul#recent-list span.time {
      color: #fed351;
      font-size: 0.89em;
      width: 34px;
      text-align: right;
    }
    @media (max-width: 420px) {
      .widget-container { max-width: 94vw; padding: 10px 8px; }
      #artwork { width: 58px; height: 58px; }
      ul#recent-list img { width: 24px; height: 24px; }
      #volume-slider, #mute-toggle { display: none; }
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <img src="ERLogo2.png" class="logo" alt="Essential Radio Logo" />
    <div class="on-air-now">ON AIR NOW</div>
    <div id="currentShow">Loading‚Ä¶</div>
    <div class="audio-controls">
      <button id="play-toggle">‚ñ∂Ô∏è</button>
      <input id="volume-slider" type="range" min="0" max="100" value="80" />
      <button id="mute-toggle">üîä</button>
    </div>
    <div class="now-playing-box">
      <img id="artwork" src="Essential Radio Logo.png" alt="Artwork" />
      <div id="now-playing">Loading‚Ä¶</div>
      <div id="now-playing-artist"></div>
    </div>
    <div class="recent-title">Recently Played</div>
    <ul id="recent-list"></ul>
  </div>

  <script>
    const audio = new Audio("https://streaming06.liveboxstream.uk/proxy/ayrshire/stream");
    audio.volume = 0.8;
    let isPlaying = false;
    let lastVolume = 0.8;
    const playBtn = document.getElementById('play-toggle');
    const muteBtn = document.getElementById('mute-toggle');
    const volumeSlider = document.getElementById('volume-slider');

    playBtn.onclick = () => {
      if (!isPlaying) {
        audio.play();
        playBtn.textContent = '‚è∏';
        isPlaying = true;
      } else {
        audio.pause();
        playBtn.textContent = '‚ñ∂Ô∏è';
        isPlaying = false;
      }
    };

    volumeSlider.oninput = function() {
      audio.volume = this.value / 100;
      lastVolume = audio.volume;
      muteBtn.textContent = audio.volume === 0 ? 'üîá' : audio.volume < 0.5 ? 'üîà' : 'üîä';
    };

    muteBtn.onclick = function() {
      if (!audio.muted && audio.volume > 0) {
        audio.muted = true;
        muteBtn.textContent = 'üîá';
        volumeSlider.value = 0;
      } else {
        audio.muted = false;
        muteBtn.textContent = lastVolume < 0.5 ? 'üîà' : 'üîä';
        volumeSlider.value = lastVolume * 100;
      }
    };

    async function fetchSchedule() {
      try {
        const res = await fetch("https://essentialradio.github.io/player/schedule.json");
        return await res.json();
      } catch {
        return null;
      }
    }

    function getCurrentShow(schedule) {
      const now = new Date();
      const day = now.toLocaleString("en-GB", { weekday: "long" });
      const shows = schedule?.[day] || [];
      const nowMins = now.getHours() * 60 + now.getMinutes();
      for (const show of shows) {
        const [sh, sm] = show.start.split(":").map(Number);
        const [eh, em] = show.end.split(":").map(Number);
        let start = sh * 60 + sm, end = eh * 60 + em;
        if (end === 0 && start > 0) end = 1440;
        if (nowMins >= start && nowMins < end) return show.title;
      }
      return "Off Air";
    }

    async function updateOnAirNow() {
      const schedule = await fetchSchedule();
      const show = schedule ? getCurrentShow(schedule) : "Loading‚Ä¶";
      const el = document.getElementById("currentShow");
      if (show.includes(" with ")) {
        const [title, presenter] = show.split(" with ");
        el.innerHTML = `<span class="show-title">${title.trim()}</span><span class="show-presenter">with ${presenter.trim()}</span>`;
      } else {
        el.textContent = show;
      }
    }

    async function updateNowPlaying() {
      try {
        const res = await fetch('https://essentialradio.github.io/player/latestTrack.json?_=' + Date.now());
        const data = await res.json();
        document.getElementById("now-playing").textContent = data.title || "Loading‚Ä¶";
        document.getElementById("now-playing-artist").textContent = data.artist ? `by ${data.artist}` : "";
        document.getElementById("artwork").src = data.artwork || "Essential Radio Logo.png";
      } catch {
        document.getElementById("now-playing").textContent = "Loading‚Ä¶";
        document.getElementById("now-playing-artist").textContent = "";
        document.getElementById("artwork").src = "Essential Radio Logo.png";
      }
    }

    async function updateRecent() {
      try {
        const res = await fetch('https://essentialradio.github.io/player/playout_log_rolling.json?_=' + Date.now());
        const data = await res.json();
        const list = document.getElementById('recent-list');
        list.innerHTML = "";
        data.slice(-8, -2).reverse().forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `
            <img src="${item.Artwork || 'Essential Radio Logo.png'}" alt="" />
            <span class="info">${item.Artist} ‚Äì ${item.Title}</span>
            <span class="time">${(item["Displayed Time"] || item["Scheduled Time"] || "").slice(0, 5)}</span>`;
          list.appendChild(li);
        });
      } catch {
        document.getElementById('recent-list').innerHTML = '<li><span class="info">Unavailable</span></li>';
      }
    }

    updateOnAirNow();
    updateNowPlaying();
    updateRecent();
    setInterval(updateOnAirNow, 60_000);
    setInterval(updateNowPlaying, 12_000);
    setInterval(updateRecent, 18_000);
  </script>
</body>
</html>
