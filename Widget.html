<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio Widget (Relative API + Smaller Mobile)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #0b0d14;
      margin: 0; padding: 0;
      display: flex; min-height: 100vh;
      align-items: center; justify-content: center;
      color: #fff;
    }
    .widget-container {
      width: 100%; max-width: 600px; height: auto;
      background: #191c29; border-radius: 20px; box-shadow: 0 4px 24px #0005;
      display: flex; flex-direction: row; overflow: hidden;
    }
    .left {
      width: 240px; min-width: 180px;
      background: #21233c;
      display: flex; flex-direction: column; align-items: center;
      padding: 20px 14px; border-right: 2px solid #fed35144;
    }
    .logo { width: 110px; border-radius: 14px; margin-bottom: 14px; }
    #artwork {
      width: 110px; height: 110px; border-radius: 10px; border: 3px solid #fed351;
      object-fit: cover; background: #222; margin-bottom: 10px;
    }
    .now-playing-info { text-align: center; width: 100%; }
    #now-playing {
      font-weight: 700; color: #fed351; margin-bottom: 2px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    #now-playing-artist {
      opacity: 0.9; font-size: 0.95em;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .right { flex: 1; display: flex; flex-direction: column; padding: 20px; }
    .on-air-now { color: #fed351; font-weight: 700; margin-bottom: 3px; }
    #currentShow { font-weight: 600; margin-bottom: 10px; line-height: 1.3; }
    .audio-controls { display: flex; gap: 10px; align-items: center; margin: 6px 0 12px; }
    #play-toggle, #mute-toggle {
      background: #fed351; color: #111; border: 0; border-radius: 6px;
      padding: 6px 12px; font-weight: 700; cursor: pointer;
    }
    #volume-slider { width: 90px; }
    .recent-title { color: #fed351; font-weight: 600; margin: 5px 0; }
    ul#recent-list { list-style: none; margin: 0; padding: 0; width: 100%; max-height: 150px; overflow-y: auto; }
    ul#recent-list li { display: flex; align-items: center; gap: 6px; padding: 5px 0; border-bottom: 1px solid #28284b; }
    ul#recent-list li:last-child { border-bottom: none; }
    ul#recent-list img { width: 30px; height: 30px; border-radius: 6px; border: 2px solid #fed351; object-fit: cover; }
    ul#recent-list span.info { flex: 1; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    ul#recent-list span.time { width: 40px; text-align: right; font-size: 0.85em; color: #fed351; }

    /* MOBILE tweaks */
    @media (max-width: 700px) {
      .widget-container { flex-direction: column; border-radius: 14px; }
      .left, .right { width: 100%; border-right: none; padding: 12px; }
      .left { flex-direction: row; align-items: center; gap: 10px; border-bottom: 2px solid #fed35133; }
      .logo { width: 70px; margin: 0; }
      #artwork { width: 64px; height: 64px; border-width: 2px; }
      #now-playing { font-size: 0.9em; }
      #now-playing-artist { font-size: 0.8em; }
      .on-air-now { font-size: 0.85em; }
      #currentShow { font-size: 0.85em; }
      #play-toggle, #mute-toggle { padding: 5px 10px; font-size: 0.85em; }
      #volume-slider { width: 70px; }
      ul#recent-list img { width: 26px; height: 26px; }
      ul#recent-list span.info { font-size: 0.8em; }
      ul#recent-list span.time { font-size: 0.75em; }
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <div class="left">
      <img src="ERLogo2.png" class="logo" alt="Essential Radio Logo" />
      <img id="artwork" src="Essential Radio Logo.png" alt="Artwork" />
      <div class="now-playing-info">
        <div id="now-playing">Loading‚Ä¶</div>
        <div id="now-playing-artist"></div>
      </div>
    </div>
    <div class="right">
      <div>
        <div class="on-air-now">ON AIR NOW</div>
        <div id="currentShow">Loading‚Ä¶</div>
        <div class="audio-controls">
          <button id="play-toggle">‚ñ∂Ô∏è</button>
          <input id="volume-slider" type="range" min="0" max="100" value="80" />
          <button id="mute-toggle">üîä</button>
        </div>
      </div>
      <div>
        <div class="recent-title">Recently Played</div>
        <ul id="recent-list"></ul>
      </div>
    </div>
  </div>

  <script>
    // === SAME-ORIGIN RELATIVE API ===
    const LATEST_TRACK_URL = "/api/latestTrack"; // works when this file is served from player-green.vercel.app
    const RECENT_URL = "https://essentialradio.github.io/player/playout_log_rolling.json";
    const SCHEDULE_URL = "https://essentialradio.github.io/player/schedule.json";

    function decodeHtmlEntities(str) {
      if (!str) return "";
      var txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }

    // ---- NOW PLAYING (relative) ----
    async function updateNowPlaying() {
      try {
        const latestRes = await fetch(LATEST_TRACK_URL + "?_=" + Date.now(), { cache: "no-store" });
        if (!latestRes.ok) throw new Error("latestTrack status " + latestRes.status);
        const latest = await latestRes.json();
        if (!latest || !latest.artist || !latest.title) throw new Error("latestTrack missing fields");

        const artist = decodeHtmlEntities(latest.artist);
        const title = decodeHtmlEntities(latest.title);

        document.getElementById("now-playing").textContent = title;
        document.getElementById("now-playing-artist").textContent = artist ? "by " + artist : "";

        // Optional iTunes artwork lookup
        const searchTerm = encodeURIComponent(artist + " " + title);
        let artwork = "Essential Radio Logo.png";
        try {
          const iTunesRes = await fetch("https://itunes.apple.com/search?term=" + searchTerm + "&media=music&limit=1");
          const iTunesData = await iTunesRes.json();
          if (iTunesData.results && iTunesData.results[0] && iTunesData.results[0].artworkUrl100) {
            artwork = iTunesData.results[0].artworkUrl100.replace("100x100", "300x300");
          }
        } catch(e) {}
        document.getElementById("artwork").src = artwork;
      } catch (e) {
        console.warn(e);
        document.getElementById("now-playing").textContent = "More music soon";
        document.getElementById("now-playing-artist").textContent = "";
        document.getElementById("artwork").src = "Essential Radio Logo.png";
      }
    }

    // ---- RECENTLY PLAYED ----
    async function updateRecent() {
      try {
        const res = await fetch(RECENT_URL + "?_=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("recent status " + res.status);
        const data = await res.json();
        const list = document.getElementById("recent-list");
        list.innerHTML = "";
        const recentItems = data.slice(-3).reverse();
        for (const item of recentItems) {
          const artist = decodeHtmlEntities(item.Artist);
          const title = decodeHtmlEntities(item.Title);
          const li = document.createElement("li");
          li.innerHTML = '<img src="Essential Radio Logo.png" alt="" />' +
                         '<span class="info">' + artist + ' ‚Äì ' + title + '</span>' +
                         '<span class="time">' + ((item["Displayed Time"] || item["Scheduled Time"] || "").slice(0, 5)) + '</span>';
          list.appendChild(li);
        }
      } catch (e) {
        console.warn(e);
        document.getElementById("recent-list").innerHTML = '<li><span class="info">Unavailable</span></li>';
      }
    }

    // ---- ON AIR NOW ----
    async function fetchSchedule() {
      try { const res = await fetch(SCHEDULE_URL, { cache: "no-store" }); return await res.json(); }
      catch { return null; }
    }
    function getCurrentShow(schedule) {
      const now = new Date();
      const day = now.toLocaleString("en-GB", { weekday: "long" });
      const shows = (schedule && schedule[day]) || [];
      const nowMins = now.getHours() * 60 + now.getMinutes();
      for (const show of shows) {
        const [sh, sm] = show.start.split(":").map(Number);
        const [eh, em] = show.end.split(":").map(Number);
        let start = sh * 60 + sm, end = eh * 60 + em;
        if (end === 0 && start > 0) end = 1440; // midnight wrap
        if (nowMins >= start && nowMins < end) return show.title;
      }
      return "Off Air";
    }
    async function updateOnAirNow() {
      const schedule = await fetchSchedule();
      const show = schedule ? getCurrentShow(schedule) : "Off Air";
      document.getElementById("currentShow").textContent = show;
    }

    // ---- INIT ----
    updateOnAirNow();
    updateNowPlaying();
    updateRecent();
    setInterval(updateOnAirNow, 60000);
    setInterval(updateNowPlaying, 12000);
    setInterval(updateRecent, 18000);
  </script>
</body>
</html>