<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essential Radio Widget ‚Äì Upgraded v7 (no CTA)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    #erw, #erw * { box-sizing: border-box; }
    #erw { font-family: 'Inter', sans-serif; color: #fff; }
    #erw .widget-shell { background: #191c29; border-radius: 20px; box-shadow: 0 4px 24px #0005; overflow: hidden; }

    /* Desktop */
    #erw .desktop { display: flex; width: 100%; height: 600px; }
    #erw .left {
      width: 260px; min-width: 200px; background: #21233c;
      display: flex; flex-direction: column; align-items: center;
      padding: 22px 18px 18px 18px; border-right: 2px solid #fed35144; height: 100%;
    }
    #erw .logo { width: 120px; border-radius: 18px; margin-bottom: 12px; user-select: none; }
    #erw .on-air-label { display: inline-flex; align-items: center; gap: 8px; color: #ff4d4d; font-weight: 700; font-size: 0.98em; margin: 4px 0 2px 0; user-select: none; }
    #erw .live-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4d4d; animation: erw-pulse 1.2s infinite; }
    @keyframes erw-pulse { 0%,100%{ opacity: .2; transform: scale(1); } 50%{ opacity: 1; transform: scale(1.4); } }

    #erw #artwork { width: 140px; height: 140px; border-radius: 12px; border: 3px solid #fed351; object-fit: cover; background: #222;
      box-shadow: 0 2px 16px #fed35133; margin: 10px 0 12px 0; opacity: 0; filter: blur(10px) brightness(.9);
      transition: opacity .4s ease-in-out, filter .4s ease-in-out; }
    #erw #artwork.loaded { opacity: 1; filter: blur(0) brightness(1); }
    #erw #artwork.fallback { filter: blur(5px) brightness(.85); opacity: .85; box-shadow: 0 0 10px rgba(254,211,81,.35); }

    #erw .now-playing-info { text-align: center; margin-bottom: 8px; }
    #erw #now-playing { font-size: 1.06em; font-weight: 700; color: #fed351; margin-bottom: 2px; }
    #erw #now-playing-artist { font-size: 0.95em; color: #fff; opacity: 0.95; }

    #erw .right { flex: 1; display: flex; flex-direction: column; padding: 22px 24px 24px 26px; background: #191c29; height: 100%; }
    #erw .right .block { margin-bottom: 12px; }

    #erw .recent-title { font-size: 1.07em; font-weight: 600; margin: 2px 0 6px 0; color: #fed351; }
    #erw ul.recent { list-style: none; margin: 0; padding: 0; width: 100%; }
    #erw ul.recent li {
      display: grid; grid-template-columns: 44px 1fr auto; align-items: center;
      gap: 12px; padding: 10px 0; border-bottom: 1px solid #28284b; font-size: 0.97em;
    }
    #erw ul.recent li:last-child { border-bottom: none; }
    #erw ul.recent img.thumb { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; border: 2px solid #fed351; background: #222; opacity: 0; transition: opacity .4s ease-in-out; }
    #erw ul.recent img.thumb.loaded { opacity: 1; }
    #erw ul.recent span.info { color: #fff; font-size: 0.98em; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    #erw ul.recent span.time { color: #fed351; font-size: 0.94em; width: 56px; text-align: right; }

    #erw .upnext { display: flex; align-items: center; gap: 10px; background: #21233c; border: 1px solid #2a2e55; border-radius: 12px; padding: 10px 12px; }
    #erw .upnext .badge { font-weight: 700; color: #111; background: #fed351; border-radius: 999px; padding: 2px 10px; font-size: .86em; }
    #erw .upnext .text { color: #fff; }
    #erw .upnext .time { color: #fed351; font-weight: 600; margin-left: auto; }

    #erw .audio-controls { display: flex; gap: 12px; align-items: center; justify-content: center; background: #1c2033; border: 1px solid #262a46; border-radius: 12px; padding: 12px; }
    #erw #play-toggle, #erw #mute-toggle { background: #fed351; color: #111; border: none; border-radius: 7px; padding: 8px 16px; font-size: 1.03em; font-weight: 700; cursor: pointer; transition: background .2s; }
    #erw #play-toggle:hover, #erw #mute-toggle:hover { background: #ffe67c; }
    #erw #volume-slider { width: 120px; }

    /* Mobile */
    #erw .mobile { display: none; width: 100%; max-width: 700px; }
    #erw .mobile .card { width: 100%; background: #191c29; border-radius: 20px; }
    #erw .m-header { display: flex; align-items: center; gap: 12px; padding: 14px; border-bottom: 2px solid #fed35133; }
    #erw .m-logo { width: 88px; border-radius: 12px; }
    #erw .m-onair { margin-left: auto; text-align: right; }
    #erw .m-onair .label { color: #fed351; font-weight: 700; font-size: 0.95em; }
    #erw .m-onair #m-currentShow { font-weight: 600; color: #fff; font-size: 0.98em; }

    #erw .m-now { display: flex; align-items: center; gap: 12px; padding: 14px; }
    #erw #m-artwork { width: 96px; height: 96px; border-radius: 10px; border: 3px solid #fed351; object-fit: cover; background: #222; opacity: 0; filter: blur(10px) brightness(.9); transition: opacity .4s ease-in-out, filter .4s ease-in-out; }
    #erw #m-artwork.loaded { opacity: 1; filter: blur(0) brightness(1); }
    #erw #m-artwork.fallback { filter: blur(5px) brightness(.85); opacity: .85; box-shadow: 0 0 10px rgba(254,211,81,.35); }
    #erw .m-title { color: #fed351; font-weight: 700; font-size: 1.02em; }
    #erw .m-artist { opacity: 0.95; }

    #erw .m-recent { padding: 8px 14px 6px 14px; }
    #erw .m-aux { padding: 8px 14px 14px 14px; display: grid; gap: 10px; }
    #erw .m-upnext { border: 1px solid #2a2e55; border-radius: 12px; padding: 10px; background: #21233c; }

    @media (max-width: 700px) {
      #erw .desktop { display: none; }
      #erw .mobile  { display: block; }
      #erw #volume-slider, #erw #mute-toggle { display: none; }
    }
  </style>
</head>
<body style="margin:0; background: transparent;">
  <div id="erw">
    <!-- Desktop layout -->
    <div class="widget-shell desktop">
      <div class="left">
        <img src="ERLogo2.png" class="logo" alt="Essential Radio Logo" />
        <div class="on-air-label"><span class="live-dot"></span>ON AIR NOW</div>
        <div id="currentShow">Loading‚Ä¶</div>
        <img id="artwork" src="Essential Radio Logo.png" alt="Artwork" class="fallback" />
        <div class="now-playing-info">
          <div id="now-playing">Loading‚Ä¶</div>
          <div id="now-playing-artist"></div>
        </div>
      </div>
      <div class="right">
        <div class="block">
          <div class="recent-title">Recently Played</div>
          <ul id="recent-list" class="recent"></ul>
        </div>
        <div class="block">
          <div class="upnext">
            <span class="badge">Up next</span>
            <span class="text" id="upnext-text">Loading‚Ä¶</span>
            <span class="time" id="upnext-time"></span>
          </div>
        </div>
        <div class="block">
          <div class="audio-controls">
            <button id="play-toggle">‚ñ∂Ô∏è</button>
            <input id="volume-slider" type="range" min="0" max="100" value="80" />
            <button id="mute-toggle">üîä</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile layout -->
    <div class="widget-shell mobile">
      <div class="card">
        <div class="m-header">
          <img src="ERLogo2.png" class="m-logo" alt="Essential Radio" />
          <div class="m-onair">
            <div class="label">ON AIR NOW</div>
            <div id="m-currentShow">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="m-now">
          <img id="m-artwork" src="Essential Radio Logo.png" alt="Artwork" class="fallback" />
          <div>
            <div id="m-now-playing" class="m-title">Loading‚Ä¶</div>
            <div id="m-now-playing-artist" class="m-artist"></div>
          </div>
        </div>
        <div class="m-recent">
          <div class="recent-title">Recently Played</div>
          <ul id="m-recent-list" class="recent"></ul>
        </div>
        <div class="m-aux">
          <div class="m-upnext">
            <strong>Up next</strong><br/>
            <span id="m-upnext-text">Loading‚Ä¶</span>
            <span style="float:right; color:#fed351; font-weight:600;" id="m-upnext-time"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* Config */
    const RECENT_COUNT = 4;
    const POLL_MS = 15000;
    const END_GRACE_MS = 4000; // end-time grace to prevent flicker

    /* Helpers */
    const io = new IntersectionObserver(entries => {
      for (const e of entries) if (e.isIntersecting) { e.target.classList.add("loaded"); io.unobserve(e.target); }
    }, { threshold: 0.1 });
    function decodeHtmlEntities(str) { if (!str) return ""; const t=document.createElement("textarea"); t.innerHTML=str; return t.value; }
    const norm = s => (s||"").replace(/[‚Äì‚Äî]/g,'-').replace(/\s+/g,' ').trim().toLowerCase();

    /* Audio (gentle watchdog) */
    const audio = new Audio("https://streaming06.liveboxstream.uk/proxy/ayrshire/stream");
    audio.preload = "none";
    audio.volume = 0.8;
    let isPlaying=false, userPaused=false, lastVolume=0.8, lastProgressMs=Date.now(), lastRestartMs=0;
    const playBtn=document.getElementById('play-toggle'), muteBtn=document.getElementById('mute-toggle'), volumeSlider=document.getElementById('volume-slider');
    function setPlayingUI(p){ isPlaying=p; if(playBtn) playBtn.textContent=p?'‚è∏':'‚ñ∂Ô∏è'; }
    function syncMuteIcon(){ if(!muteBtn) return; const v=audio.muted?0:audio.volume; muteBtn.textContent = v===0?'üîá':(v<0.5?'üîà':'üîä'); }
    function startPlayback(){ userPaused=false; if(audio.readyState===0) audio.load(); audio.play().then(()=>setPlayingUI(true)).catch(()=>{}); }
    function pausePlayback(){ userPaused=true; audio.pause(); setPlayingUI(false); }
    if (playBtn) playBtn.onclick=()=>{ isPlaying?pausePlayback():startPlayback(); };
    if (volumeSlider) volumeSlider.oninput=function(){ audio.volume=this.value/100; lastVolume=audio.volume; syncMuteIcon(); };
    if (muteBtn) muteBtn.onclick=()=>{ if(!audio.muted && audio.volume>0){ audio.muted=true; if (volumeSlider) volumeSlider.value=0; } else { audio.muted=false; if (volumeSlider) volumeSlider.value=Math.round(lastVolume*100); } syncMuteIcon(); };
    audio.addEventListener('timeupdate', ()=>{ if(!audio.paused) lastProgressMs=Date.now(); });
    audio.addEventListener('playing', ()=>{ setPlayingUI(true); lastProgressMs=Date.now(); });
    audio.addEventListener('pause',   ()=>{ if(!userPaused) setPlayingUI(false); });
    function attemptRestart(){ const now=Date.now(); if(userPaused||document.hidden) return; if(now-lastRestartMs<45_000) return; lastRestartMs=now; try{ audio.pause(); audio.load(); audio.play().then(()=>setPlayingUI(true)).catch(()=>{});}catch{} }
    audio.addEventListener('error', attemptRestart);
    audio.addEventListener('ended', attemptRestart);
    setInterval(()=>{ if(!isPlaying||userPaused||document.hidden) return; if(Date.now()-lastProgressMs>25_000) attemptRestart(); }, 10_000);

    /* Schedule: On Air + Up Next */
    async function fetchSchedule() { try { const r = await fetch("https://essentialradio.github.io/player/schedule.json"); return await r.json(); } catch { return null; } }
    function minutes(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }
    function getCurrentAndNext(schedule){
      const now = new Date(); const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      const today = days[now.getDay()]; const shows = schedule?.[today] || []; const nm = now.getHours()*60 + now.getMinutes();
      let cur=null, next=null;
      for (let i=0;i<shows.length;i++){ const s=minutes(shows[i].start), e=minutes(shows[i].end||"24:00"); const end=(e===0 && s>0)?1440:e;
        if(nm>=s && nm<end){ cur=shows[i]; next=shows[i+1]||null; break; } if(nm < s && !next) next=shows[i]; }
      if(!next){ const list = schedule?.[days[(now.getDay()+1)%7]] || []; next=list[0]||null; if(next) next._tomorrow = true; }
      return {cur,next};
    }
    function renderShow(el, show){
      if(!el) return;
      if(!show){ el.textContent = "Off Air"; return; }
      if ((show.title||'').includes(" with ")) { const [t,p]=(show.title||"").split(" with "); el.innerHTML = `<span>${decodeHtmlEntities(t.trim())}</span><br><span style="font-weight:400;font-size:0.9em;opacity:0.9;">with ${decodeHtmlEntities(p.trim())}</span>`; }
      else { el.textContent = decodeHtmlEntities(show.title||show); }
    }
    async function updateScheduleBlocks(){
      const s = await fetchSchedule(); const {cur,next} = getCurrentAndNext(s||{});
      renderShow(document.getElementById("currentShow"), cur || {title:"Off Air"});
      renderShow(document.getElementById("m-currentShow"), cur || {title:"Off Air"});
      const upText = (next?.title) ? next.title : "More music"; const timeStr = (next?.start)||""; const when = next?._tomorrow?"Tomorrow":"Today";
      const pairs = [{t:document.getElementById("upnext-text"), time:document.getElementById("upnext-time")},
                     {t:document.getElementById("m-upnext-text"), time:document.getElementById("m-upnext-time")}];
      for (const el of pairs){ if(el.t) el.t.textContent = decodeHtmlEntities(upText); if(el.time) el.time.textContent = timeStr ? `${when} ‚Ä¢ ${timeStr}` : ""; }
    }

    /* Now Playing with change-detection */
    const npTitleEls  = [document.getElementById("now-playing"), document.getElementById("m-now-playing")];
    const npArtistEls = [document.getElementById("now-playing-artist"), document.getElementById("m-now-playing-artist")];
    const artworkEls  = [document.getElementById("artwork"), document.getElementById("m-artwork")];
    let npLastKey=null, trackEndTimeout=null, npAbort=null;

    function applyArtworkFallback(){ for (const img of artworkEls){ if (!img) continue; img.classList.remove('loaded'); img.classList.add('fallback'); img.src='Essential Radio Logo.png'; } }
    async function applyArtwork(trackName){
      try {
        const res = await fetch(`/api/artwork?q=${encodeURIComponent(trackName)}&_=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw 0;
        const j = await res.json();
        if (!j || !j.url) throw 0;
        const newBase = j.url;
        for (const img of artworkEls){
          if (!img) continue;
          const curBase = (img.dataset.srcbase||"");
          if (curBase === newBase) continue;
          const url = newBase + (newBase.includes('?')?'&':'?') + 'ts=' + Date.now();
          img.dataset.srcbase = newBase;
          const pre = new Image();
          pre.onload = () => { img.classList.remove('fallback'); img.classList.add('loaded'); img.src = url; };
          pre.onerror = applyArtworkFallback;
          pre.src = url;
        }
      } catch { applyArtworkFallback(); }
    }
    function showMoreMusicSoon(){
      for (const el of npTitleEls)  { if (el) el.textContent = "More music soon"; }
      for (const el of npArtistEls) { if (el) el.textContent = "on Essential Radio"; }
      document.title = "Essential Radio: More music soon";
      applyArtworkFallback();
    }
    async function fetchNowPlaying(){
      try{
        if (npAbort) npAbort.abort();
        npAbort = new AbortController();
        const r = await fetch('/api/latestTrack?_=' + Date.now(), { cache: 'no-store', signal: npAbort.signal });
        const latest = await r.json();
        if (!latest || !latest.artist || !latest.title || !latest.duration || !latest.startTime) { showMoreMusicSoon(); return; }

        const artist = decodeHtmlEntities(latest.artist);
        const title  = decodeHtmlEntities(latest.title);
        const startMs = new Date(latest.startTime).getTime();
        const endMs   = startMs + latest.duration * 1000;
        if (Date.now() > endMs + END_GRACE_MS) { showMoreMusicSoon(); return; }

        const key = `${norm(artist)}||${norm(title)}||${startMs}`;
        if (key === npLastKey) return;
        npLastKey = key;

        for (const el of npTitleEls)  { if (el && el.textContent !== title)  el.textContent = title; }
        for (const el of npArtistEls) { const txt = artist ? `by ${artist}` : ""; if (el && el.textContent !== txt) el.textContent = txt; }
        document.title = `Essential Radio: ${artist} ‚Äì ${title}`;
        applyArtwork(`${artist} - ${title}`);

        if (trackEndTimeout) clearTimeout(trackEndTimeout);
        trackEndTimeout = setTimeout(showMoreMusicSoon, Math.max(0, endMs + END_GRACE_MS - Date.now()));
      } catch(e){ if (e && e.name === 'AbortError') return; showMoreMusicSoon(); }
    }

    /* Recently Played (4 items) */
    let recentLastJSON = "";
    async function getTrackArtwork(query){
      try { const res = await fetch(`/api/artwork?q=${encodeURIComponent(query)}&_=${Date.now()}`, { cache: 'no-store' }); if (res.ok) { const d=await res.json(); if (d && d.url) return d.url; } } catch {}
      return 'Essential Radio Logo.png';
    }
    async function fetchRecent(){
      try {
        const res = await fetch('https://essentialradio.github.io/player/playout_log_rolling.json?_=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw 0;
        const data = await res.json();
        let items = data.filter(it => it.Artist && it.Title).slice(-RECENT_COUNT*2).reverse();
        if (npLastKey){ const [aNorm,tNorm] = npLastKey.split('||'); items = items.filter(it => norm(it.Artist)!==aNorm || norm(it.Title)!==tNorm); }
        items = items.slice(0, RECENT_COUNT);

        const compact = JSON.stringify(items.map(it => [it.Artist, it.Title, (it['Displayed Time'] || it['Scheduled Time'] || '').slice(0,5)]));
        if (compact === recentLastJSON) return;
        recentLastJSON = compact;

        async function toLI(it){
          const time = (it['Displayed Time'] || it['Scheduled Time'] || '').slice(0,5);
          const name = `${it.Artist} ‚Äì ${it.Title}`;
          const art  = await getTrackArtwork(name);
          const li = document.createElement('li');
          li.innerHTML = `<img class="thumb" src="${art}" alt="Cover for ${name}"/><span class="info">${name}</span><span class="time">${time}</span>`;
          return li;
        }
        const lists=[document.getElementById('recent-list'), document.getElementById('m-recent-list')];
        for (const ul of lists){ if (!ul) continue; ul.innerHTML=''; for (const it of items){ const li=await toLI(it); ul.appendChild(li); } }
        document.querySelectorAll('img.thumb').forEach(img => io.observe(img));
      } catch {}
    }

    /* Boot */
    function startIntervals(){
      if (window._erwIntervalsStarted) return;
      window._erwIntervalsStarted = true;
      updateScheduleBlocks(); fetchNowPlaying(); fetchRecent();
      setInterval(updateScheduleBlocks, 60_000);
      setInterval(fetchNowPlaying,      POLL_MS);
      setInterval(fetchRecent,          15_000);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', startIntervals, { once:true });
    else startIntervals();
  </script>
</body>
</html>
