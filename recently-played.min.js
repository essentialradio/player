/*! recently-played.min.js (timezone-aware, safe standalone) */
(function(){
  "use strict";
  var API="https://player-green.vercel.app/api/recent?limit=10";
  var DEFAULT_IMG = (typeof window!=="undefined" && window.DEFAULT_COVER_URL) ? window.DEFAULT_COVER_URL : "Essential Radio Logo.png";
  function q(id){return document.getElementById(id)}
  function hhmm(t){
    if(!t) return "";
    var s = String(t);
    try{
      if(/\d{4}-\d{2}-\d{2}T/.test(s)){
        var d = new Date(s);
        return new Intl.DateTimeFormat('en-GB', { timeZone: 'Europe/London', hour: '2-digit', minute: '2-digit', hour12: false }).format(d);
      }
    }catch(e){}
    return /^\d{2}:\d{2}$/.test(s) ? s : s.slice(11,16);
  }
  async function getArt(name){
    try{
      if(typeof window.getTrackArtwork==="function"){
        var art = await window.getTrackArtwork(name);
        return art || DEFAULT_IMG;
      }
    }catch(e){}
    return DEFAULT_IMG;
  }
  function norm(rows){
    if(!Array.isArray(rows)) return [];
    var seen={};
    var out=[];
    for(var i=0;i<rows.length;i++){
      var it=rows[i]||{};
      var artist=it.Artist||it.artist||"";
      var title =it.Title ||it.title ||"";
      var time  =it["Scheduled Time"]||it.startTime||it.startedAt||"";
      if(!artist||!title) continue;
      var key=artist+"—"+title+"—"+time;
      if(seen[key]) continue; seen[key]=1;
      var name=artist+" – "+title;
      if(typeof window.currentTrackID==="string" && name===window.currentTrackID) continue;
      out.push({artist:artist,title:title,time:time,name:name});
      if(out.length>=10) break;
    }
    return out.slice(0,5);
  }
  async function render(items){
    var list=q("recent-list"); if(!list) return;
    var html=[];
    for(var i=0;i<items.length;i++){
      var it=items[i];
      var art = await getArt(it.name);
      var lastfm="https://www.last.fm/music/"+encodeURIComponent(it.artist.replace(/\s+/g,"+"));
      html.push(
        '<li>' +
          '<span class="time">'+ hhmm(it.time) +'</span>' +
          '<img src="'+ art +'" alt="Cover for '+ it.name.replace(/"/g,'&quot;') +'" loading="lazy" />' +
          '<span class="info">'+ it.name +
            ' <a href="'+ lastfm +'" target="_blank" rel="noopener" class="lastfm-link" title="More about '+ it.artist.replace(/"/g,'&quot;') +' on Last.fm">↗</a>' +
          '</span>' +
        '</li>'
      );
    }
    list.innerHTML = html.join("");
    try{
      if(window.observer){
        list.querySelectorAll('img[loading="lazy"]').forEach(function(img){window.observer.observe(img)});
      }
    }catch(e){}
  }
  async function fetchRecentlyPlayed(){
    try{
      var res=await fetch(API+'&_='+Date.now(),{cache:'no-store'});
      if(!res.ok) throw new Error('recent API '+res.status);
      var data=await res.json();
      var items=norm(data);
      await render(items);
    }catch(e){
      console.error("Recently Played error:",e);
    }
  }
  window.fetchRecentlyPlayed = fetchRecentlyPlayed;
  function start(){
    if(!window.recentInterval){
      fetchRecentlyPlayed();
      window.recentInterval = setInterval(fetchRecentlyPlayed, 20000);
    }
  }
  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", start, {once:true});
  } else { start(); }
})();